<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0A1628">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ROURA CEVASA · CFO</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;500;600;700;800&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<script>/* Box OAuth 2.0 PKCE — no external library needed */</script>
<style>
/* ===================================================
   ROURA CEVASA CFO APP · STYLES
   Industrial/Utilitarian aesthetic – dark steel + amber
   =================================================== */

:root {
  --bg: #0A1628;
  --bg2: #0F1E38;
  --surface: #162035;
  --surface2: #1C2A42;
  --border: #253450;
  --accent: #006B97;
  --accent2: #1A8FBF;
  --accent-soft: rgba(0, 107, 151, 0.15);
  --accent-red: #E84040;
  --accent-green: #20C060;
  --text: #E8EDF5;
  --text2: #8CA0BC;
  --text3: #4A6080;
  --white: #FFFFFF;
  --radius: 8px;
  --radius-lg: 14px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-accent: 0 4px 20px rgba(0,107,151,0.25);
  --font-main: 'Barlow', sans-serif;
  --font-cond: 'Barlow Condensed', sans-serif;
  --transition: 0.22s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  width: 100%; height: 100%; max-width: 480px; margin: 0 auto;
  background: var(--bg); color: var(--text);
  font-family: var(--font-main); font-size: 15px; line-height: 1.5;
  overflow-x: hidden;
}

/* ===== SCREENS ===== */
.screen {
  display: none; position: fixed; inset: 0; max-width: 480px; margin: 0 auto;
  background: var(--bg); overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}
.screen.active { display: flex; flex-direction: column; }

/* ===== MAIN SCREEN ===== */
#screen-main {
  background: var(--bg);
  justify-content: center; align-items: stretch;
}
.main-bg {
  position: fixed; inset: 0; max-width: 480px; margin: 0 auto;
  overflow: hidden; pointer-events: none;
}
.grid-overlay {
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(0,107,151,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,107,151,0.04) 1px, transparent 1px);
  background-size: 40px 40px;
}
.main-bg::after {
  content:''; position:absolute; bottom:-100px; right:-100px;
  width: 400px; height: 400px;
  background: radial-gradient(circle, rgba(0,107,151,0.12) 0%, transparent 70%);
}
.main-content {
  position: relative; z-index: 1;
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; min-height: 100vh;
  padding: 40px 28px;
}
.brand-header {
  display: flex; align-items: center; gap: 18px; margin-bottom: 60px;
}
.brand-logo {
  width: 64px; height: 64px;
  background: var(--accent);
  border-radius: var(--radius);
  display: flex; align-items: center; justify-content: center;
  box-shadow: var(--shadow-accent);
}
.brand-r {
  font-family: var(--font-cond); font-size: 26px; font-weight: 800;
  color: var(--bg); letter-spacing: 1px;
}
.brand-name {
  font-family: var(--font-cond); font-size: 22px; font-weight: 700;
  letter-spacing: 2px; color: var(--text);
}
.brand-sub {
  font-size: 11px; font-weight: 500; letter-spacing: 2px;
  color: var(--text2); text-transform: uppercase;
}
.main-menu { width: 100%; }
.main-btn {
  width: 100%; background: var(--surface);
  border: 1px solid var(--border); border-left: 3px solid var(--accent);
  border-radius: var(--radius-lg); padding: 22px 20px;
  display: flex; align-items: center; gap: 16px; cursor: pointer;
  color: var(--text); transition: var(--transition);
  box-shadow: var(--shadow);
}
.main-btn:active { transform: scale(0.98); background: var(--surface2); }
.btn-icon {
  width: 48px; height: 48px; border-radius: var(--radius);
  background: var(--accent-soft); display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.btn-icon svg { width: 24px; height: 24px; color: var(--accent); }
.btn-label { flex: 1; text-align: left; }
.btn-title { font-family: var(--font-cond); font-size: 20px; font-weight: 700; letter-spacing: 1.5px; color: var(--text); display: block; }
.btn-desc { font-size: 12px; color: var(--text2); letter-spacing: 0.5px; }
.btn-arrow { font-size: 28px; color: var(--accent); font-weight: 300; }
.version-tag { margin-top: 48px; font-size: 11px; color: var(--text3); letter-spacing: 1px; }

/* ===== TOPBAR ===== */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: var(--bg2); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 12px;
  height: 56px; flex-shrink: 0;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}
.back-btn {
  background: none; border: none; color: var(--accent);
  font-size: 32px; width: 44px; height: 44px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  border-radius: 8px; transition: var(--transition); flex-shrink: 0;
  line-height: 1;
}
.back-btn:active { background: var(--accent-soft); }
.topbar-title {
  flex: 1; font-family: var(--font-cond); font-size: 18px; font-weight: 700;
  letter-spacing: 2px; color: var(--text); text-align: center;
}
.topbar-right { width: 44px; display: flex; justify-content: flex-end; }
.counter-badge {
  background: var(--accent); color: var(--bg);
  font-family: var(--font-cond); font-size: 13px; font-weight: 700;
  padding: 3px 10px; border-radius: 20px; letter-spacing: 0.5px;
}

/* ===== SCREEN BODY ===== */
.screen-body { flex: 1; padding: 20px 16px 32px; display: flex; flex-direction: column; gap: 16px; }

/* ===== SECTION HEADER ===== */
.section-header {
  display: flex; align-items: center; gap: 16px;
  background: var(--surface); border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius-lg); padding: 18px;
}
.section-icon {
  width: 48px; height: 48px; background: var(--accent-soft);
  border-radius: var(--radius); display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.section-icon svg { width: 26px; height: 26px; color: var(--accent); }
.section-title { font-family: var(--font-cond); font-size: 18px; font-weight: 700; letter-spacing: 1px; }
.section-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }

/* ===== INFO CARDS ===== */
.info-cards {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
}
.info-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 12px;
  display: flex; align-items: center; gap: 10px;
}
.info-card-num {
  font-family: var(--font-cond); font-size: 28px; font-weight: 800;
  color: var(--accent); opacity: 0.6; line-height: 1;
}
.info-card-text { font-size: 12px; color: var(--text2); line-height: 1.3; }

/* ===== ACTION BUTTONS ===== */
.action-btn {
  width: 100%; border: none; border-radius: var(--radius-lg);
  padding: 16px 24px; font-family: var(--font-cond); font-size: 17px;
  font-weight: 700; letter-spacing: 1.5px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 12px;
  transition: var(--transition); flex-shrink: 0;
}
.action-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
.primary-action {
  background: var(--accent); color: var(--bg);
  box-shadow: var(--shadow-accent);
}
.primary-action:active { transform: scale(0.98); background: var(--accent2); }
.secondary-action {
  background: transparent; color: var(--text2);
  border: 1px solid var(--border);
  font-size: 13px;
}
.secondary-action:active { background: var(--surface); }

/* ===== FORMS ===== */
.form-section { display: flex; flex-direction: column; gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-label {
  font-family: var(--font-cond); font-size: 12px; font-weight: 600;
  letter-spacing: 1.5px; color: var(--text2); text-transform: uppercase;
}
.req { color: var(--accent); }
.form-input, .form-select, .form-textarea {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 13px 14px;
  color: var(--text); font-family: var(--font-main); font-size: 15px;
  width: 100%; transition: var(--transition); outline: none;
  -webkit-appearance: none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft);
}
.form-input::placeholder, .form-textarea::placeholder { color: var(--text3); }
.form-select { cursor: pointer; }
.form-select option { background: var(--surface2); }
.form-textarea { resize: vertical; min-height: 100px; }
.location-row { display: flex; gap: 8px; }
.flex-1 { flex: 1; }
.geo-btn {
  width: 50px; height: 50px; background: var(--accent-soft); border: 1px solid var(--accent);
  border-radius: var(--radius); cursor: pointer; color: var(--accent);
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  transition: var(--transition);
}
.geo-btn svg { width: 22px; height: 22px; }
.geo-btn:active { background: var(--accent); color: var(--bg); }
.geo-status { font-size: 11px; color: var(--text2); margin-top: 2px; }
.form-divider {
  display: flex; align-items: center; gap: 12px;
  margin: 6px 0;
}
.form-divider::before, .form-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}
.form-divider span {
  font-family: var(--font-cond); font-size: 11px; font-weight: 600;
  letter-spacing: 2px; color: var(--accent); white-space: nowrap;
}

/* ===== INCIDENCIA CODE BAR ===== */
.incidencia-code-bar {
  background: var(--bg2); border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius); padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.code-label { font-family: var(--font-cond); font-size: 11px; font-weight: 600; letter-spacing: 2px; color: var(--text3); }
.code-value { font-family: var(--font-cond); font-size: 20px; font-weight: 700; color: var(--accent); letter-spacing: 1px; }

/* ===== BLOCK CARDS ===== */
.block-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 16px; display: flex; flex-direction: column; gap: 12px;
}
.block-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 2px;
}
.block-num {
  font-family: var(--font-cond); font-size: 13px; font-weight: 800;
  color: var(--accent); background: var(--accent-soft);
  border-radius: 4px; padding: 3px 8px; letter-spacing: 0.5px;
}
.block-title { font-family: var(--font-cond); font-size: 14px; font-weight: 700; letter-spacing: 1px; flex: 1; }
.block-count { font-size: 12px; color: var(--text2); }

/* ===== FOTOS GRID ===== */
.fotos-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
}
.foto-thumb {
  aspect-ratio: 1; border-radius: var(--radius); overflow: hidden;
  position: relative; background: var(--surface2); cursor: pointer;
}
.foto-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
.foto-remove {
  position: absolute; top: 4px; right: 4px; width: 22px; height: 22px;
  background: rgba(0,0,0,0.75); border-radius: 50%; border: none;
  color: white; font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; line-height: 1;
}
.foto-add {
  aspect-ratio: 1; border: 2px dashed var(--border); border-radius: var(--radius);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 4px; color: var(--text3); font-size: 11px; cursor: pointer;
  background: var(--surface2); transition: var(--transition);
}
.foto-add:hover { border-color: var(--accent); color: var(--accent); }
.foto-add svg { width: 20px; height: 20px; }

.foto-actions { display: flex; gap: 10px; }
.foto-btn {
  flex: 1; background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px; cursor: pointer; color: var(--text);
  font-family: var(--font-main); font-size: 13px; font-weight: 500;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: var(--transition);
}
.foto-btn svg { width: 20px; height: 20px; }
.foto-btn:active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }

/* ===== AUDIO BTN ===== */
.audio-btn {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 11px 16px; cursor: pointer;
  color: var(--text2); font-family: var(--font-main); font-size: 13px;
  display: flex; align-items: center; gap: 10px; width: 100%;
  transition: var(--transition);
}
.audio-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
.audio-btn.recording {
  border-color: var(--accent-red); color: var(--accent-red);
  background: rgba(232,64,64,0.1); animation: pulse-rec 1s ease-in-out infinite;
}
@keyframes pulse-rec {
  0%, 100% { box-shadow: 0 0 0 0 rgba(232,64,64,0.3); }
  50% { box-shadow: 0 0 0 8px rgba(232,64,64,0); }
}

/* ===== BLOQUE DINÁMICO TIPOS ===== */
.dynamic-block {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 16px;
  display: flex; flex-direction: column; gap: 12px;
  border-top: 2px solid var(--accent);
}
.dynamic-block .block-header { margin-bottom: 2px; }

/* ===== RESUMEN ===== */
.resumen-header {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px;
  display: flex; justify-content: space-around;
}
.resumen-stat { text-align: center; }
.stat-num { font-family: var(--font-cond); font-size: 40px; font-weight: 800; color: var(--accent); line-height: 1; }
.stat-label { font-size: 11px; color: var(--text2); letter-spacing: 0.5px; margin-top: 4px; }
.resumen-list { display: flex; flex-direction: column; gap: 10px; }

.resumen-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 14px 16px;
  display: flex; align-items: flex-start; gap: 12px; cursor: pointer;
  transition: var(--transition); position: relative;
}
.resumen-card:active { background: var(--surface2); }
.resumen-card-code {
  font-family: var(--font-cond); font-size: 13px; font-weight: 700;
  color: var(--accent); background: var(--accent-soft);
  border-radius: 4px; padding: 4px 8px; flex-shrink: 0; line-height: 1.4;
}
.resumen-card-body { flex: 1; min-width: 0; }
.resumen-card-desc {
  font-size: 13px; color: var(--text); display: -webkit-box;
  -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.resumen-card-meta { font-size: 11px; color: var(--text2); margin-top: 4px; display: flex; gap: 12px; flex-wrap: wrap; }
.tag {
  font-family: var(--font-cond); font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
  padding: 2px 8px; border-radius: 3px;
}
.tag-material { background: rgba(232,64,64,0.15); color: #E86060; }
.tag-doc { background: rgba(80,120,200,0.15); color: #6090E0; }
.tag-equipo { background: rgba(32,192,96,0.15); color: #40D090; }
.edit-icon { color: var(--text3); flex-shrink: 0; margin-top: 2px; }
.edit-icon svg { width: 18px; height: 18px; }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed; inset: 0; max-width: 480px; margin: 0 auto;
  background: rgba(0,0,0,0.75); z-index: 1000;
  display: flex; align-items: flex-end; padding: 16px;
}
.modal-box {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
  padding: 24px; width: 100%; max-height: 85vh; overflow-y: auto;
  display: flex; flex-direction: column; gap: 16px;
}
.modal-title {
  font-family: var(--font-cond); font-size: 18px; font-weight: 700; letter-spacing: 1px;
  color: var(--accent);
}
.modal-content { display: flex; flex-direction: column; gap: 12px; }
.modal-actions { display: flex; gap: 10px; margin-top: 4px; }
.modal-btn {
  flex: 1; padding: 13px; border-radius: var(--radius);
  font-family: var(--font-cond); font-size: 15px; font-weight: 700;
  letter-spacing: 1px; cursor: pointer; border: none; transition: var(--transition);
}
.modal-btn.cancel { background: var(--surface2); color: var(--text2); }
.modal-btn.confirm { background: var(--accent); color: var(--bg); }

/* ===== TOAST ===== */
.toast {
  position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(100px);
  max-width: 360px; width: calc(100% - 32px);
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 18px;
  font-size: 14px; color: var(--text); z-index: 9999;
  transition: transform 0.3s cubic-bezier(0.4,0,0.2,1), opacity 0.3s;
  text-align: center; box-shadow: var(--shadow);
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--accent-green); }
.toast.error { border-color: var(--accent-red); }

/* ===== LOADING ===== */
.loading-overlay {
  position: fixed; inset: 0; max-width: 480px; margin: 0 auto;
  background: rgba(10,22,40,0.9); z-index: 2000;
  display: flex; align-items: center; justify-content: center;
}
.loading-box { text-align: center; }
.loading-spinner {
  width: 44px; height: 44px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 14px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-family: var(--font-cond); font-size: 14px; letter-spacing: 1px; color: var(--text2); }

/* ===== RESPONSIVE + MISC ===== */
input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* Botón volver al inicio */
.volver-inicio-btn {
  background: transparent;
  color: var(--accent);
  border: 2px solid var(--accent);
  font-size: 15px;
  animation: fadeInUp 0.4s ease;
}
.volver-inicio-btn:active { background: var(--accent-soft); }
@keyframes fadeInUp {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}
/* Logo imagen en pantalla principal */
.brand-logo-img {
  width:90px; height:90px; flex-shrink:0;
  background: white;
  border-radius: 50%;
  display:flex; align-items:center; justify-content:center;
  box-shadow: 0 4px 20px rgba(0,107,151,0.3);
  overflow:hidden;
}

/* ===== CONFIG / INTEGRATIONS BUTTON ===== */
.settings-btn {
  position: absolute; top: 14px; right: 14px;
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text2); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}
.settings-btn:active { background: var(--accent-soft); color: var(--accent); }
.settings-btn svg { width: 20px; height: 20px; }

/* ===== CONFIG STATUS BADGE ===== */
.config-status-bar {
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 14px;
  margin-bottom: 4px;
}
.status-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.status-dot.ok { background: var(--accent-green); }
.status-dot.warn { background: #E8A020; }
.status-dot.off { background: var(--text3); }
.status-label { font-family: var(--font-cond); font-size: 11px; font-weight: 600; letter-spacing: 1px; }
.status-val { font-size: 11px; color: var(--text2); }

/* ===== CLOUD FOLDER STATUS ===== */
.cloud-folder-info {
  display: flex; align-items: center; gap: 10px;
  background: rgba(0,107,151,0.1); border: 1px solid rgba(0,107,151,0.3);
  border-radius: var(--radius); padding: 10px 14px;
  font-size: 12px; color: var(--text2);
}
.cloud-folder-info svg { width: 18px; height: 18px; color: var(--accent); flex-shrink: 0; }
.cloud-folder-name { color: var(--accent); font-weight: 600; font-family: var(--font-cond); }

/* ===== UPLOAD PROGRESS ===== */
.upload-pill {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(32,192,96,0.1); border: 1px solid rgba(32,192,96,0.3);
  border-radius: 20px; padding: 4px 10px;
  font-size: 11px; color: var(--accent-green); font-weight: 600;
}
.upload-pill.uploading { background: rgba(0,107,151,0.1); border-color: rgba(0,107,151,0.3); color: var(--accent); }
.upload-pill.error { background: rgba(232,64,64,0.1); border-color: rgba(232,64,64,0.3); color: var(--accent-red); }

/* ===== EMAIL BUTTON ===== */
.email-action {
  background: linear-gradient(135deg, #0A6B4B 0%, #0E8F65 100%);
  color: white;
  box-shadow: 0 4px 20px rgba(10,107,75,0.3);
}
.email-action:active { transform: scale(0.98); }

/* ===== CONFIG SCREEN FORM ===== */
.config-section-title {
  font-family: var(--font-cond); font-size: 13px; font-weight: 700;
  letter-spacing: 2px; color: var(--accent); text-transform: uppercase;
  display: flex; align-items: center; gap: 10px;
  padding-bottom: 8px; border-bottom: 1px solid var(--border);
}
.config-section-title svg { width: 16px; height: 16px; }
.config-hint {
  background: var(--bg2); border-left: 3px solid var(--accent);
  border-radius: 0 var(--radius) var(--radius) 0;
  padding: 10px 14px; font-size: 12px; color: var(--text2); line-height: 1.6;
}
.config-hint a { color: var(--accent); }
.config-hint code {
  background: var(--surface2); padding: 1px 5px; border-radius: 3px;
  font-family: monospace; font-size: 11px; color: var(--text);
}
.form-input-mono { font-family: monospace; font-size: 13px; }
.config-test-btn {
  width: 100%; background: var(--surface2); border: 1px dashed var(--border);
  border-radius: var(--radius); padding: 12px; font-family: var(--font-cond);
  font-size: 14px; font-weight: 600; letter-spacing: 1px; cursor: pointer;
  color: var(--text2); transition: var(--transition);
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.config-test-btn:active { border-color: var(--accent); color: var(--accent); }
.config-test-btn svg { width: 18px; height: 18px; }

/* ===== RESUMEN SEND ROW ===== */
.send-actions { display: flex; flex-direction: column; gap: 8px; }
.inc-cloud-tag {
  font-size: 10px; color: var(--accent-green); margin-left: 6px;
  font-family: var(--font-cond); font-weight: 600; letter-spacing: 0.5px;
}

/* ===== GOOGLE SIGN-IN BUTTON ===== */
.google-signin-btn {
  background: #fff;
  color: #3c4043;
  border: 1.5px solid #dadce0;
  font-family: var(--font-cond);
  font-size: 15px;
  font-weight: 700;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 14px 24px;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}
.google-signin-btn:active { background: #f8f9fa; transform: scale(0.98); }

/* ===== GOOGLE USER CARD ===== */
.google-user-card {
  background: var(--surface);
  border: 1px solid var(--accent);
  border-radius: var(--radius-lg);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 14px;
}
.google-user-avatar {
  width: 42px; height: 42px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  font-family: var(--font-cond);
  font-size: 18px;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  overflow: hidden;
}
.google-user-avatar img { width: 100%; height: 100%; object-fit: cover; }
.google-user-info { flex: 1; min-width: 0; }
.google-user-name { font-family: var(--font-cond); font-size: 15px; font-weight: 700; color: var(--text); }
.google-user-email { font-size: 11px; color: var(--text2); margin-top: 2px; }
.google-signout-btn {
  background: none; border: 1px solid var(--border);
  border-radius: var(--radius); padding: 8px;
  color: var(--text3); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition); flex-shrink: 0;
}
.google-signout-btn svg { width: 18px; height: 18px; }
.google-signout-btn:active { color: var(--accent-red); border-color: var(--accent-red); }

/* ===== MAIN TABS (VISITA / CERRAR CFO) ===== */
.main-tabs {
  display: flex; width: 100%;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 4px;
  gap: 4px; margin-bottom: 18px;
}
.main-tab {
  flex: 1; padding: 11px 8px;
  border: none; border-radius: var(--radius);
  font-family: var(--font-cond); font-size: 14px; font-weight: 700;
  letter-spacing: 1px; cursor: pointer;
  transition: var(--transition); color: var(--text2);
  background: transparent;
}
.main-tab.active {
  background: var(--accent); color: var(--bg);
  box-shadow: var(--shadow-accent);
}
.main-tab-panel { display: none; width: 100%; }
.main-tab-panel.active { display: flex; flex-direction: column; gap: 14px; }

/* ===== CERRAR CFO — LOAD ZONE ===== */
.load-zone {
  border: 2px dashed var(--border); border-radius: var(--radius-lg);
  padding: 32px 20px; text-align: center;
  display: flex; flex-direction: column; align-items: center; gap: 12px;
  cursor: pointer; transition: var(--transition);
}
.load-zone:active, .load-zone.drag-over {
  border-color: var(--accent); background: var(--accent-soft);
}
.load-zone-icon { width: 52px; height: 52px; color: var(--text3); }
.load-zone-title { font-family: var(--font-cond); font-size: 17px; font-weight: 700; letter-spacing: 1px; }
.load-zone-sub { font-size: 12px; color: var(--text2); }

/* ===== CIERRE PROGRESS BAR ===== */
.cierre-progress-bar {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px 16px;
  display: flex; flex-direction: column; gap: 8px;
}
.cierre-progress-label {
  font-family: var(--font-cond); font-size: 12px; font-weight: 700;
  letter-spacing: 1.5px; color: var(--text2);
  display: flex; justify-content: space-between;
}
.cierre-progress-track {
  height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden;
}
.cierre-progress-fill {
  height: 100%; background: var(--accent); border-radius: 3px;
  transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
}

/* ===== CIERRE INCIDENCIA CARD (en listado) ===== */
.cierre-inc-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; transition: var(--transition);
}
.cierre-inc-card:active { background: var(--surface2); }
.cierre-inc-card.done { border-left: 3px solid var(--accent-green); }
.cierre-inc-card.pending { border-left: 3px solid var(--text3); }
.cierre-status-dot {
  width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
}
.cierre-status-dot.done { background: var(--accent-green); }
.cierre-status-dot.pending { background: var(--text3); }
.cierre-inc-info { flex: 1; min-width: 0; }
.cierre-inc-codigo {
  font-family: var(--font-cond); font-size: 13px; font-weight: 700; color: var(--accent);
}
.cierre-inc-desc {
  font-size: 12px; color: var(--text2); margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ===== ORIGINAL INCIDENCIA BLOCK (en cierre individual) ===== */
.original-inc-block {
  background: var(--bg2); border: 1px solid var(--border);
  border-top: 3px solid var(--accent);
  border-radius: var(--radius-lg); padding: 14px;
  display: flex; flex-direction: column; gap: 10px;
}
.original-inc-header {
  font-family: var(--font-cond); font-size: 11px; font-weight: 700;
  letter-spacing: 2px; color: var(--accent); text-transform: uppercase;
  display: flex; align-items: center; gap: 8px;
}
.original-inc-header::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}
.original-inc-desc {
  font-size: 13px; color: var(--text); line-height: 1.5;
}
.original-inc-extra {
  font-size: 12px; color: var(--text2); line-height: 1.4;
}

/* ===== CIERRE RESOLUTION BLOCK ===== */
.cierre-resolution-block {
  background: var(--surface); border: 1px solid var(--border);
  border-top: 3px solid var(--accent-green);
  border-radius: var(--radius-lg); padding: 14px;
  display: flex; flex-direction: column; gap: 14px;
}
.cierre-resolution-header {
  font-family: var(--font-cond); font-size: 11px; font-weight: 700;
  letter-spacing: 2px; color: var(--accent-green); text-transform: uppercase;
  display: flex; align-items: center; gap: 8px;
}
.cierre-resolution-header::after {
  content: ''; flex: 1; height: 1px; background: rgba(32,192,96,0.2);
}

/* ===== LOGIN SCREEN ===== */
#screen-login {
  background: var(--bg);
  justify-content: center; align-items: center;
  min-height: 100vh;
}
.login-wrap {
  position: relative; z-index: 2;
  display: flex; flex-direction: column; align-items: center;
  padding: 40px 28px; width: 100%;
}
.login-card {
  background: var(--surface); border: 1px solid var(--border);
  border-top: 3px solid var(--accent);
  border-radius: var(--radius-lg); padding: 36px 28px;
  width: 100%; box-shadow: var(--shadow);
}
.login-logo { text-align: center; margin-bottom: 32px; }
.login-logo img { width: 80px; height: 80px; object-fit: contain; background: white; border-radius: 50%; padding: 4px; }
.login-title {
  font-family: var(--font-cond); font-size: 22px; font-weight: 800;
  letter-spacing: 2px; text-align: center; color: var(--text); margin-top: 12px;
}
.login-sub { font-size: 11px; color: var(--text2); text-align: center; letter-spacing: 1px; margin-top: 4px; }
.login-error {
  background: rgba(232,64,64,0.1); border: 1px solid rgba(232,64,64,0.3);
  border-radius: var(--radius); padding: 10px 14px;
  font-size: 13px; color: var(--accent-red); text-align: center; margin-bottom: 16px;
  display: none;
}

/* ===== ADMIN PANEL ===== */
#screen-admin {
  background: var(--bg);
}
.admin-header-bar {
  background: var(--bg2); border-bottom: 1px solid var(--border);
  padding: 10px 16px; display: flex; align-items: center; gap: 10px;
}
.admin-header-bar span {
  font-family: var(--font-cond); font-size: 12px; letter-spacing: 1.5px;
  color: var(--accent); font-weight: 700;
}
.user-row {
  display: flex; align-items: center; gap: 12px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 16px; transition: var(--transition);
}
.user-row-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--accent); color: var(--bg);
  font-family: var(--font-cond); font-size: 16px; font-weight: 800;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.user-row-info { flex: 1; min-width: 0; }
.user-row-name { font-family: var(--font-cond); font-size: 15px; font-weight: 700; letter-spacing: 0.5px; }
.user-row-role { font-size: 11px; color: var(--text2); letter-spacing: 0.5px; }
.user-row-online { font-size: 11px; margin-top: 2px; }
.user-row-online.on { color: var(--accent-green); }
.user-row-online.off { color: var(--text3); }
.user-row-actions { display: flex; gap: 6px; }
.icon-btn {
  width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border);
  background: none; color: var(--text2); cursor: pointer; transition: var(--transition);
  display: flex; align-items: center; justify-content: center;
}
.icon-btn svg { width: 15px; height: 15px; }
.icon-btn:active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
.icon-btn.del:active { background: rgba(232,64,64,0.1); border-color: var(--accent-red); color: var(--accent-red); }

/* ===== MAPA ADMIN ===== */
#screen-mapa {
  background: var(--bg);
}
.mapa-wrap {
  flex: 1; position: relative; overflow: hidden;
  background: var(--bg2);
}
#spain-svg {
  width: 100%; height: 100%;
  min-height: 340px;
}
#spain-svg path { fill: var(--surface); stroke: var(--border); stroke-width: 0.8; transition: fill .3s; }
.map-user-marker {
  position: absolute; transform: translate(-50%, -100%);
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  z-index: 10; cursor: pointer;
  animation: markerDrop .4s cubic-bezier(.34,1.56,.64,1);
}
@keyframes markerDrop { from{opacity:0;transform:translate(-50%,-120%)} to{opacity:1;transform:translate(-50%,-100%)} }
.map-pin {
  width: 12px; height: 12px; border-radius: 50%;
  background: var(--accent); border: 2px solid var(--text);
  box-shadow: 0 0 0 3px rgba(0,107,151,.3), 0 0 10px rgba(0,107,151,.5);
  animation: pinPulse 2s infinite;
}
.map-pin.offline { background: var(--text3); box-shadow: none; animation: none; }
@keyframes pinPulse {
  0%,100% { box-shadow: 0 0 0 3px rgba(0,107,151,.3), 0 0 10px rgba(0,107,151,.5); }
  50% { box-shadow: 0 0 0 6px rgba(0,107,151,.1), 0 0 18px rgba(0,107,151,.3); }
}
.map-label {
  background: rgba(10,22,40,.9); border: 1px solid var(--border);
  border-radius: 4px; padding: 2px 7px; font-family: var(--font-cond);
  font-size: 10px; font-weight: 700; letter-spacing: .5px; white-space: nowrap;
  color: var(--text);
}
.map-users-list {
  background: var(--bg2); border-top: 1px solid var(--border);
  padding: 12px 16px; display: flex; flex-direction: column; gap: 8px;
  max-height: 200px; overflow-y: auto;
}
.map-user-item {
  display: flex; align-items: center; gap: 10px;
  font-size: 13px;
}
.map-user-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.map-user-dot.on { background: var(--accent-green); }
.map-user-dot.off { background: var(--text3); }
.live-badge {
  display: inline-flex; align-items: center; gap: 5px;
  font-family: var(--font-cond); font-size: 11px; font-weight: 700;
  letter-spacing: 1.5px; color: var(--accent-green);
}
.live-badge::before {
  content: ''; width: 7px; height: 7px; border-radius: 50%;
  background: var(--accent-green); animation: pinPulse 1.5s infinite;
}

/* ===== MODAL USUARIOS ===== */
#modal-user .modal-box {
  max-height: 80vh; overflow-y: auto;
}

/* ===== LOGOUT BTN ===== */
.logout-mini {
  margin-left: auto; background: none; border: 1px solid var(--border);
  border-radius: 6px; color: var(--text3); padding: 6px 10px;
  font-family: var(--font-cond); font-size: 11px; font-weight: 700;
  letter-spacing: 1px; cursor: pointer; transition: var(--transition);
  display: flex; align-items: center; gap: 5px;
}
.logout-mini:active { border-color: var(--accent-red); color: var(--accent-red); }
.logout-mini svg { width: 13px; height: 13px; }

</style>
</head>
<body>

<!-- ===== PANTALLA LOGIN ===== -->
<div id="screen-login" class="screen active">
  <div class="main-bg"><div class="grid-overlay"></div></div>
  <div class="login-wrap">
    <div class="login-card">
      <div class="login-logo">
        <img src="data:image/png;base64,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" alt="ROURA" style="width:80px;height:80px;object-fit:contain;background:white;border-radius:50%;padding:4px;">
        <div class="login-title">ROURA CEVASA</div>
        <div class="login-sub">ACCESO AL PANEL CFO</div>
      </div>
      <div id="login-error" class="login-error"></div>
      <div class="form-section">
        <div class="form-group">
          <label class="form-label">Usuario</label>
          <input type="text" id="login-username" class="form-input" placeholder="nombre de usuario" autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label">Contraseña</label>
          <input type="password" id="login-password" class="form-input" placeholder="••••••••" autocomplete="current-password">
        </div>
      </div>
      <div style="height:20px"></div>
      <button class="action-btn primary-action" onclick="doLogin()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
          <path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4M10 17l5-5-5-5M15 12H3"/>
        </svg>
        <span>ENTRAR</span>
      </button>
    </div>
    <div class="version-tag" style="margin-top:24px">v9.0 · Dropbox multi-usuario activo</div>
  </div>
</div>

<!-- ===== PANTALLA ADMIN: GESTIÓN USUARIOS ===== -->
<div id="screen-admin" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-main')">‹</button>
    <div class="topbar-title">ADMINISTRACIÓN</div>
    <div class="topbar-right" style="display:flex;gap:4px">
      <button id="btn-admin-dropbox-link" onclick="abrirCarpetaUsuariosDropbox()"
        title="Abrir carpeta usuarios en Dropbox"
        style="display:none;background:none;border:none;cursor:pointer;padding:6px;color:#0061FF;opacity:0.85">
        <svg viewBox="0 0 40 32" width="22" height="18" fill="#0061FF">
          <path d="M20 7.2L10 13.6 20 20l10-6.4L20 7.2zM10 13.6L0 20l10 6.4 10-6.4-10-6.4zM20 20l-10 6.4 10 6.4 10-6.4L20 20zM30 13.6L20 7.2 10 13.6 20 20l10-6.4z"/>
        </svg>
      </button>
      <button class="icon-btn" onclick="goTo('screen-mapa')" title="Ver mapa">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6-3V7m6 16l4.553-2.276A1 1 0 0021 19.382V8.618a1 1 0 00-.553-.894L15 5m0 15V5m0 0L9 7"/></svg>
      </button>
    </div>
  </div>
  <div class="screen-body">

    <!-- Crear nuevo usuario -->
    <div class="section-header" style="border-left-color:var(--accent-green)">
      <div class="section-icon" style="background:rgba(32,192,96,0.1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="1.5">
          <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/>
          <path d="M19 8v6M22 11h-6"/>
        </svg>
      </div>
      <div>
        <div class="section-title">Nuevo Usuario</div>
        <div class="section-desc">Crear acceso al sistema CFO</div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-group">
        <label class="form-label">Nombre completo <span class="req">*</span></label>
        <input type="text" id="new-fullname" class="form-input" placeholder="Juan García">
      </div>
      <div class="form-group">
        <label class="form-label">Usuario <span class="req">*</span></label>
        <input type="text" id="new-username" class="form-input" placeholder="jgarcia">
      </div>
      <div class="form-group">
        <label class="form-label">Contraseña <span class="req">*</span></label>
        <input type="password" id="new-password" class="form-input" placeholder="mín. 6 caracteres">
      </div>
      <div class="form-group">
        <label class="form-label">Rol</label>
        <select id="new-role" class="form-select">
          <option value="user">Técnico / Usuario</option>
          <option value="admin">Administrador</option>
        </select>
      </div>
    </div>
    <!-- Estado Dropbox en panel admin -->
    <div id="admin-dropbox-status" style="
      background:var(--surface2);border:1px solid var(--border);border-radius:8px;
      padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px;
      font-size:12px;color:var(--text2)">
      <span id="admin-dbx-dot" style="width:8px;height:8px;border-radius:50%;background:var(--text3);flex-shrink:0"></span>
      <span id="admin-dbx-lbl" style="flex:1">Verificando Dropbox...</span>
      <button onclick="dbxSyncManual()" style="
        background:transparent;border:1px solid var(--border);border-radius:6px;
        padding:4px 10px;color:var(--text2);font-size:11px;cursor:pointer;
        font-family:var(--font-cond);letter-spacing:0.5px" title="Sincronizar usuarios con Dropbox">
        ↻ SYNC
      </button>
    </div>
    <div id="admin-msg" style="font-size:13px;min-height:16px;color:var(--accent-green)"></div>
    <button class="action-btn primary-action" style="background:var(--accent-green);color:var(--bg)" onclick="adminCreateUser()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      <span>CREAR USUARIO</span>
    </button>

    <!-- Lista de usuarios -->
    <div class="form-divider"><span>USUARIOS DEL SISTEMA</span></div>
    <div id="admin-users-list" style="display:flex;flex-direction:column;gap:8px"></div>

  </div>
</div>

<!-- ===== PANTALLA MAPA EN TIEMPO REAL ===== -->
<div id="screen-mapa" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-admin')">‹</button>
    <div class="topbar-title">MAPA EN TIEMPO REAL</div>
    <div class="topbar-right">
      <div class="live-badge">LIVE</div>
    </div>
  </div>

  <div class="mapa-wrap" id="mapa-wrap" style="position:relative;">
    <!-- SVG España -->
    <svg id="spain-svg" viewBox="80 60 580 420" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;min-height:380px;display:block;">
      <!-- Península -->
      <path d="M175,105 L210,88 L255,80 L310,75 L375,72 L440,75 L500,82 L545,95 L575,115 L598,140 L610,170 L612,205 L605,240 L590,275 L565,308 L535,335 L500,355 L460,365 L415,368 L370,362 L325,350 L285,332 L252,308 L225,278 L205,245 L192,210 L184,175 L178,145 Z"/>
      <!-- Galicia región -->
      <path d="M175,105 L215,88 L230,110 L215,140 L185,148 L168,128 Z" opacity="0.6"/>
      <!-- Cataluña -->
      <path d="M555,100 L600,128 L610,168 L575,175 L548,148 L540,115 Z" opacity="0.6"/>
      <!-- Canarias box -->
      <rect x="100" y="380" width="155" height="85" rx="6" fill="#1C2A42" stroke="#253450" stroke-width="0.8"/>
      <text x="177" y="395" text-anchor="middle" font-size="8" fill="#4A6080" font-family="sans-serif" font-weight="600" letter-spacing="1">ISLAS CANARIAS</text>
      <ellipse cx="125" cy="435" rx="20" ry="13" fill="#162035" stroke="#253450" stroke-width="0.6"/>
      <ellipse cx="158" cy="428" rx="25" ry="15" fill="#162035" stroke="#253450" stroke-width="0.6"/>
      <ellipse cx="200" cy="435" rx="22" ry="13" fill="#162035" stroke="#253450" stroke-width="0.6"/>
      <ellipse cx="235" cy="430" rx="16" ry="10" fill="#162035" stroke="#253450" stroke-width="0.6"/>
      <!-- Baleares -->
      <ellipse cx="598" cy="290" rx="28" ry="18" fill="#162035" stroke="#253450" stroke-width="0.6"/>
      <text x="598" y="294" text-anchor="middle" font-size="7" fill="#4A6080" font-family="sans-serif">Baleares</text>
      <!-- Ciudades capitales -->
      <circle cx="380" cy="230" r="3" fill="#006B97" opacity="0.5"/>
      <text x="386" y="233" font-size="7" fill="#4A6080" font-family="sans-serif">Madrid</text>
      <circle cx="545" cy="140" r="3" fill="#006B97" opacity="0.5"/>
      <text x="551" y="143" font-size="7" fill="#4A6080" font-family="sans-serif">BCN</text>
      <circle cx="235" cy="345" r="3" fill="#006B97" opacity="0.5"/>
      <text x="241" y="348" font-size="7" fill="#4A6080" font-family="sans-serif">Sevilla</text>
      <circle cx="476" cy="310" r="3" fill="#006B97" opacity="0.5"/>
      <text x="482" y="313" font-size="7" fill="#4A6080" font-family="sans-serif">Valencia</text>
      <circle cx="285" cy="178" r="3" fill="#006B97" opacity="0.5"/>
      <text x="291" y="181" font-size="7" fill="#4A6080" font-family="sans-serif">Valladolid</text>
    </svg>
    <!-- Marcadores dinámicos -->
    <div id="map-markers" style="position:absolute;inset:0;pointer-events:none;"></div>
  </div>

  <div style="background:var(--surface);border-top:1px solid var(--border);padding:8px 16px;display:flex;gap:16px;font-size:11px;color:var(--text3)">
    <span>📍 <span style="color:var(--accent-green)">GPS REAL</span></span>
    <span>📌 Estimado</span>
    <span><span style="color:var(--accent-green)">●</span> En línea</span>
    <span>● Desconectado</span>
  </div>
  <div class="map-users-list" id="map-users-list">
    <div style="font-size:11px;color:var(--text3);letter-spacing:1px;font-family:var(--font-cond);font-weight:700">USUARIOS CONECTADOS</div>
  </div>
</div>

<!-- Modal editar/cambiar contraseña usuario -->
<div id="modal-user" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <div class="modal-title" id="modal-user-title">Editar usuario</div>
    <div id="modal-user-content" class="modal-content"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeUserModal()">CANCELAR</button>
      <button class="modal-btn confirm" onclick="saveUserModal()">GUARDAR</button>
    </div>
  </div>
</div>

<!-- ===== PANTALLA 1: MENÚ PRINCIPAL ===== -->
<div id="screen-main" class="screen">
  <div class="main-bg">
    <div class="grid-overlay"></div>
  </div>
  <!-- Botones superiores -->
  <button class="settings-btn" onclick="goTo('screen-config')" title="Configuración integraciones" style="z-index:10;right:60px">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
      <circle cx="12" cy="12" r="3"/>
    </svg>
  </button>
  <!-- Botón Admin (solo visible para admins) -->
  <button class="settings-btn" id="btn-admin-menu" onclick="goTo('screen-admin')" title="Panel administración" style="z-index:10;right:14px;display:none">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
  </button>
  <div class="main-content">
    <div class="brand-header">
      <div class="brand-logo-img">
        <img src="data:image/png;base64,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" alt="ROURA CEVASA" style="width:90px;height:90px;object-fit:contain;display:block;">
      </div>
      <div class="brand-text">
        <div class="brand-name">ROURA CEVASA</div>
        <div class="brand-sub">GESTIÓN DE INSTALACIONES</div>
      </div>
    </div>
    <div class="main-tabs">
      <button class="main-tab active" id="tab-visita" onclick="switchMainTab('visita')">VISITA CFO</button>
      <button class="main-tab" id="tab-cerrar" onclick="switchMainTab('cerrar')">CERRAR CFO</button>
    </div>

    <!-- TAB PANEL: VISITA CFO -->
    <div class="main-tab-panel active" id="panel-visita">
      <button class="main-btn" onclick="goTo('screen-cfo-menu')">
        <div class="btn-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <div class="btn-label">
          <span class="btn-title">NUEVA VISITA</span>
          <span class="btn-desc">Registrar incidencias CFO</span>
        </div>
        <div class="btn-arrow">›</div>
      </button>
      <button class="main-btn" onclick="triggerCargarJSON()" style="border-left-color:var(--accent-green)">
        <div class="btn-icon" style="background:rgba(32,192,96,0.1)">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="1.5">
            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
        </div>
        <div class="btn-label">
          <span class="btn-title" style="color:var(--accent-green)">CARGAR VISITA</span>
          <span class="btn-desc">Continuar / modificar informe .json existente</span>
        </div>
        <div class="btn-arrow" style="color:var(--accent-green)">›</div>
      </button>
      <input type="file" id="cargar-visita-input" accept=".json" style="display:none" onchange="cargarVisitaJSON(this)">
    </div>

    <!-- TAB PANEL: CERRAR CFO -->
    <div class="main-tab-panel" id="panel-cerrar">
      <div class="load-zone" id="cierre-load-zone" onclick="triggerCierreFile()">
        <svg class="load-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <div class="load-zone-title">CARGAR INFORME CFO</div>
        <div class="load-zone-sub">Toca para seleccionar el archivo .json<br>generado al crear el informe</div>
      </div>
      <input type="file" id="cierre-file-input" accept=".json,application/json" style="display:none" onchange="cargarInformeCierre(this)">

      <!-- Informe cargado: resumen -->
      <div id="cierre-loaded-card" style="display:none"
           class="original-inc-block">
        <div class="original-inc-header">INFORME CARGADO</div>
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <div style="font-family:var(--font-cond);font-size:16px;font-weight:700;color:var(--text)" id="cierre-pedido-label">—</div>
            <div style="font-size:12px;color:var(--text2);margin-top:3px" id="cierre-meta-label">—</div>
          </div>
          <button onclick="resetCierre()" style="background:none;border:1px solid var(--border);border-radius:var(--radius);padding:8px;color:var(--text3);cursor:pointer;font-size:11px;font-family:var(--font-cond);letter-spacing:1px">CAMBIAR</button>
        </div>
      </div>

      <!-- Botón iniciar cierre -->
      <button class="action-btn primary-action" id="btn-iniciar-cierre" style="display:none" onclick="iniciarCierreFlow()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>INICIAR CIERRE DE INCIDENCIAS</span>
      </button>

      <!-- Separador cargar cierre existente -->
      <div class="form-divider" id="div-cargar-cierre-existente" style="display:none"><span>O BIEN</span></div>
      <button class="main-btn" id="btn-cargar-cierre-json" onclick="triggerCargarCierreJSON()" style="display:none;border-left-color:var(--accent-green)">
        <div class="btn-icon" style="background:rgba(32,192,96,0.1)">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="1.5">
            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
        </div>
        <div class="btn-label">
          <span class="btn-title" style="color:var(--accent-green)">MODIFICAR CIERRE</span>
          <span class="btn-desc">Cargar un .json de cierre ya existente para editarlo</span>
        </div>
        <div class="btn-arrow" style="color:var(--accent-green)">›</div>
      </button>
      <input type="file" id="cargar-cierre-file" accept=".json" style="display:none" onchange="cargarCierreExistente(this)">
    </div>
    <div class="version-tag" style="display:flex;align-items:center;gap:10px;justify-content:center;flex-wrap:wrap">
      <span id="main-user-label" style="color:var(--text2);font-size:11px;letter-spacing:1px"></span>
      <span style="color:var(--text3)">·</span>
      <span>v1.0.0</span>
      <span style="color:var(--text3)">·</span>
      <button onclick="doLogout()" style="background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;letter-spacing:1px;font-family:var(--font-cond);font-weight:600">CERRAR SESIÓN</button>
    </div>
  </div>
</div>

<!-- ===== PANTALLA: CIERRE — LISTA INCIDENCIAS ===== -->
<div id="screen-cierre-lista" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-main')">‹</button>
    <div class="topbar-title">CERRAR CFO</div>
    <div class="topbar-right">
      <span class="counter-badge" id="cierre-counter-badge">0/0</span>
    </div>
  </div>
  <div class="screen-body">

    <!-- Info del proyecto -->
    <div class="original-inc-block" style="gap:6px">
      <div class="original-inc-header">PROYECTO</div>
      <div style="font-family:var(--font-cond);font-size:18px;font-weight:800;color:var(--text)" id="cierre-lista-pedido">—</div>
      <div style="font-size:12px;color:var(--text2)" id="cierre-lista-meta">—</div>
    </div>

    <!-- Barra de progreso -->
    <div class="cierre-progress-bar">
      <div class="cierre-progress-label">
        <span>PROGRESO DE CIERRE</span>
        <span id="cierre-progress-text">0 / 0 cerradas</span>
      </div>
      <div class="cierre-progress-track">
        <div class="cierre-progress-fill" id="cierre-progress-fill" style="width:0%"></div>
      </div>
    </div>

    <!-- Lista incidencias -->
    <div id="cierre-inc-list" class="resumen-list"></div>

    <!-- Botón generar informe cierre (aparece cuando todas cerradas) -->
    <button class="action-btn primary-action" id="btn-generar-cierre" style="display:none" onclick="generarInformeCierre()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span>GENERAR INFORME DE CIERRE</span>
    </button>

    <!-- Botón guardar cierre JSON (siempre visible) -->
    <button class="action-btn" onclick="guardarCierreJSON()" style="background:var(--surface2);border:1px solid var(--accent-green);color:var(--accent-green)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
      </svg>
      <span>GUARDAR PROGRESO CIERRE .JSON</span>
    </button>

    <!-- Botón volver al inicio (aparece tras generar el informe) -->
    <button class="action-btn volver-inicio-btn" id="btn-cierre-volver-inicio" style="display:none" onclick="volverAlInicioCierre()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
        <polyline points="9,22 9,12 15,12 15,22"/>
      </svg>
      <span>VOLVER AL INICIO</span>
    </button>

  </div>
</div>

<!-- ===== PANTALLA: CIERRE — INCIDENCIA INDIVIDUAL ===== -->
<div id="screen-cierre-inc" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-cierre-lista')">‹</button>
    <div class="topbar-title" id="cierre-inc-title">CIERRE #001</div>
    <div class="topbar-right"></div>
  </div>
  <div class="screen-body">

    <!-- Código incidencia -->
    <div class="incidencia-code-bar">
      <div class="code-label">CÓDIGO</div>
      <div class="code-value" id="cierre-inc-codigo">—</div>
    </div>

    <!-- Incidencia original (solo lectura) -->
    <div class="original-inc-block">
      <div class="original-inc-header">INCIDENCIA ORIGINAL</div>
      <div class="original-inc-desc" id="cierre-orig-desc">—</div>
      <div class="original-inc-extra" id="cierre-orig-extra" style="display:none"></div>
      <div id="cierre-orig-tipo-badge" style="margin-top:4px"></div>
    </div>

    <!-- Resolución -->
    <div class="cierre-resolution-block">
      <div class="cierre-resolution-header">RESOLUCIÓN</div>

      <!-- Apartado 1: Fotografías de cierre -->
      <div class="block-card" style="gap:12px;padding:14px">
        <div class="block-header">
          <span class="block-num">01</span>
          <span class="block-title">FOTOGRAFÍAS DE RESOLUCIÓN</span>
          <span class="block-count" id="cierre-foto-count">0 fotos</span>
        </div>
        <div class="fotos-grid" id="cierre-fotos-grid"></div>
        <div class="foto-actions">
          <button class="foto-btn" onclick="cierreAddFoto('camera')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Cámara
          </button>
          <button class="foto-btn" onclick="cierreAddFoto('gallery')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            Galería
          </button>
        </div>
        <input type="file" id="cierre-foto-input" accept="image/*" multiple style="display:none" onchange="handleCierreFotoInput(this)">
        <input type="file" id="cierre-camera-input" accept="image/*" capture="environment" style="display:none" onchange="handleCierreFotoInput(this)">
      </div>

      <!-- Apartado 2: Comentario/justificación -->
      <div class="block-card" style="gap:12px;padding:14px">
        <div class="block-header">
          <span class="block-num">02</span>
          <span class="block-title">JUSTIFICACIÓN DEL CIERRE</span>
        </div>
        <textarea id="cierre-comentario" class="form-textarea" rows="5"
          placeholder="Describe cómo se ha resuelto la incidencia, acciones tomadas, materiales utilizados, etc."></textarea>
        <button class="audio-btn" id="audio-cierre-btn" onclick="toggleAudioCierre('cierre-comentario','audio-cierre-btn')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
            <path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/>
          </svg>
          <span>Dictar justificación</span>
        </button>
      </div>
    </div>

    <!-- Guardar cierre -->
    <button class="action-btn primary-action" onclick="guardarCierreIncidencia()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span>GUARDAR CIERRE</span>
    </button>

  </div>
</div>

<!-- ===== PANTALLA 2: SUBMENÚ CFO ===== -->
<div id="screen-cfo-menu" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-main')">‹</button>
    <div class="topbar-title">VISITA CFO</div>
    <div class="topbar-right"></div>
  </div>
  <div class="screen-body">
    <div class="section-header">
      <div class="section-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-2 10v-5a1 1 0 00-1-1h-2a1 1 0 00-1 1v5m4 0H9"/>
        </svg>
      </div>
      <div>
        <div class="section-title">Documentación CFO</div>
        <div class="section-desc">Certificado Final de Obra · Registro de Incidencias</div>
      </div>
    </div>

    <div class="info-cards">
      <div class="info-card">
        <div class="info-card-num">01</div>
        <div class="info-card-text">Datos de la instalación</div>
      </div>
      <div class="info-card">
        <div class="info-card-num">02</div>
        <div class="info-card-text">Registro de incidencias</div>
      </div>
      <div class="info-card">
        <div class="info-card-num">03</div>
        <div class="info-card-text">Revisión y validación</div>
      </div>
      <div class="info-card">
        <div class="info-card-num">04</div>
        <div class="info-card-text">Generación de informe PDF</div>
      </div>
    </div>

    <button class="action-btn primary-action" onclick="goTo('screen-datos')">
      <span>INICIAR DOCUMENTACIÓN CFO</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</div>

<!-- ===== PANTALLA CONFIG: INTEGRACIONES ===== -->
<div id="screen-config" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-main')">‹</button>
    <div class="topbar-title">DROPBOX · INTEGRACIONES</div>
    <div class="topbar-right"></div>
  </div>
  <div class="screen-body">

    <!-- Estado conexión Dropbox -->
    <div id="config-status-bar" class="config-status-bar">
      <span class="status-dot off" id="dot-google"></span>
      <span class="status-label">DROPBOX</span>
      <span class="status-val" id="lbl-google">No conectado</span>
      <span style="flex:1"></span>
      <span class="status-dot off" id="dot-drive"></span>
      <span class="status-label">CARPETA</span>
      <span class="status-val" id="lbl-drive">—</span>
    </div>

    <!-- ── DROPBOX APP KEY ── -->
    <div class="form-section" style="gap:12px">
      <div class="config-section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
        </svg>
        DROPBOX · APP KEY (OAuth 2.0 PKCE)
      </div>
      <div class="config-hint">
        Configura Dropbox para almacenar todos los archivos. Es gratuito:<br>
        1. Ve a <a href="https://www.dropbox.com/developers/apps" target="_blank">dropbox.com/developers/apps</a> → <strong>Create app</strong><br>
        2. Elige <strong>Scoped access</strong> → <strong>Full Dropbox</strong><br>
        3. Nombre: <code>ROURA CFO App</code><br>
        4. En <strong>Permissions</strong> activa: <code>files.content.write</code>, <code>files.content.read</code>, <code>account_info.read</code>, <code>files.metadata.write</code><br>
        5. En <strong>Settings → OAuth 2 → Redirect URIs</strong>: añade la URL de la app<br>
        6. Copia el <strong>App key</strong> (en Settings)<br>
        7. Pega abajo y pulsa <strong>CONECTAR CON DROPBOX</strong>
      </div>
      <div class="form-group">
        <label class="form-label">Dropbox App Key <span class="req">*</span></label>
        <input type="text" id="cfg-google-client-id" class="form-input form-input-mono"
          placeholder="xxxxxxxxxxxxxxxxxxxx"
          oninput="saveConfig()">
      </div>
      <div class="form-group">
        <label class="form-label">Email destinatario por defecto</label>
        <input type="email" id="cfg-email-dest" class="form-input"
          placeholder="responsable@empresa.com" oninput="saveConfig()">
      </div>
    </div>

    <!-- ── CONECTAR CON DROPBOX ── -->
    <button class="action-btn google-signin-btn" id="btn-google-signin" onclick="googleSignIn()">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M6 2L12 6.5L18 2L24 6.5L18 11L24 15.5L18 20L12 15.5L6 20L0 15.5L6 11L0 6.5L6 2Z" fill="#0061FF" transform="scale(0.42) translate(2,2)"/>
        <path d="M6 2L12 6.5L18 2L24 6.5L18 11L24 15.5L18 20L12 15.5L6 20L0 15.5L6 11L0 6.5L6 2Z" fill="#0061FF" transform="scale(0.42) translate(2,2)"/>
        <path fill="#0061FF" d="M5 3.5L12 8l7-4.5L22 6l-10 6.5L2 6l3-2.5zm0 11L2 12l3-2.5 7 4.5 7-4.5 3 2.5-3 2.5L12 20l-7-5.5z"/>
      </svg>
      CONECTAR CON DROPBOX
    </button>

    <!-- Estado usuario conectado -->
    <div id="google-user-card" class="google-user-card" style="display:none">
      <div class="google-user-avatar" id="google-avatar" style="background:#0061FF">D</div>
      <div class="google-user-info">
        <div class="google-user-name" id="google-user-name">—</div>
        <div class="google-user-email" id="google-user-email">—</div>
      </div>
      <button class="google-signout-btn" onclick="googleSignOut()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/>
        </svg>
      </button>
    </div>

    <button class="action-btn primary-action" onclick="guardarConfig()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
        <polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/>
      </svg>
      <span>GUARDAR CONFIGURACIÓN</span>
    </button>
  </div>
</div>

<!-- ===== PANTALLA 3: DATOS INSTALACIÓN ===== -->
<div id="screen-datos" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-cfo-menu')">‹</button>
    <div class="topbar-title">DATOS INSTALACIÓN</div>
    <div class="topbar-right"></div>
  </div>
  <div class="screen-body">
    <div class="form-section">
      <div class="form-group">
        <label class="form-label">Número de Pedido <span class="req">*</span></label>
        <input type="text" id="num-pedido" class="form-input" placeholder="Ej: PED-2024-001">
      </div>
      <div class="form-group">
        <label class="form-label">Punto de Abanderamiento <span class="req">*</span></label>
        <input type="text" id="punto-abanderamiento" class="form-input" placeholder="Ej: Central Térmica Norte">
      </div>
      <div class="form-group">
        <label class="form-label">Fecha <span class="req">*</span></label>
        <input type="date" id="fecha-visita" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Ubicación <span class="req">*</span></label>
        <div class="location-row">
          <input type="text" id="ubicacion" class="form-input flex-1" placeholder="Obteniendo ubicación...">
          <button class="geo-btn" onclick="getLocation()" title="Obtener ubicación">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3M2 12h3m14 0h3"/>
            </svg>
          </button>
        </div>
        <div id="geo-status" class="geo-status"></div>
      </div>

      <div class="form-divider">
        <span>DATOS DEL INGENIERO</span>
      </div>

      <div class="form-group">
        <label class="form-label">Nombre del Ingeniero <span class="req">*</span></label>
        <input type="text" id="nombre-ingeniero" class="form-input" placeholder="Nombre completo">
      </div>
      <div class="form-group">
        <label class="form-label">Teléfono del Ingeniero <span class="req">*</span></label>
        <input type="tel" id="tel-ingeniero" class="form-input" placeholder="+34 600 000 000">
      </div>
      <div class="form-group">
        <label class="form-label">Email del Ingeniero <span class="req">*</span></label>
        <input type="email" id="email-ingeniero" class="form-input" placeholder="ingeniero@empresa.com">
      </div>
    </div>

    <button class="action-btn primary-action" onclick="validarDatos()">
      <span>VALIDAR Y CONTINUAR</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</div>

<!-- ===== PANTALLA 4: REGISTRO INCIDENCIAS ===== -->
<div id="screen-incidencia" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="confirmGoBack()">‹</button>
    <div class="topbar-title" id="incidencia-title">INCIDENCIA #001</div>
    <div class="topbar-right">
      <span id="incidencia-counter" class="counter-badge">1/50</span>
    </div>
  </div>
  <div class="screen-body">

    <!-- Código de incidencia -->
    <div class="incidencia-code-bar">
      <div class="code-label">CÓDIGO</div>
      <div class="code-value" id="codigo-incidencia">–</div>
      <div id="inc-upload-status" style="display:none"></div>
    </div>

    <!-- Carpeta cloud activa -->
    <div id="cloud-folder-bar" class="cloud-folder-info" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
      </svg>
      <div>
        <div style="font-size:10px;color:var(--text3);letter-spacing:1px;font-weight:600">CARPETA DROPBOX</div>
        <div class="cloud-folder-name" id="cloud-folder-name">–</div>
      </div>
    </div>

    <!-- BLOQUE 1: Fotografías -->
    <div class="block-card">
      <div class="block-header">
        <div class="block-num">01</div>
        <div class="block-title">FOTOGRAFÍAS DE LA INCIDENCIA</div>
        <div class="block-count" id="foto-count">0/15</div>
      </div>
      <div id="fotos-preview" class="fotos-grid"></div>
      <div class="foto-actions">
        <button class="foto-btn" onclick="triggerCamera()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          Cámara
        </button>
        <button class="foto-btn" onclick="triggerGaleria()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21,15 16,10 5,21"/>
          </svg>
          Galería
        </button>
      </div>
      <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" multiple onchange="handleFotos(this)">
      <input type="file" id="gallery-input" accept="image/*" style="display:none" multiple onchange="handleFotos(this)">
    </div>

    <!-- BLOQUE 2: Descripción -->
    <div class="block-card">
      <div class="block-header">
        <div class="block-num">02</div>
        <div class="block-title">DESCRIPCIÓN DE LA INCIDENCIA</div>
      </div>
      <textarea id="descripcion-incidencia" class="form-textarea" placeholder="Describe detalladamente la incidencia observada..." rows="5"></textarea>
      <button class="audio-btn" id="audio-desc-btn" onclick="toggleAudio('descripcion-incidencia', 'audio-desc-btn')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
          <path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4m-4 0h8"/>
        </svg>
        <span>Dictar descripción</span>
      </button>
    </div>

    <!-- BLOQUE 3: Tipo de incidencia -->
    <div class="block-card">
      <div class="block-header">
        <div class="block-num">03</div>
        <div class="block-title">TIPO DE INCIDENCIA</div>
      </div>
      <select id="tipo-incidencia" class="form-select" onchange="handleTipoChange()">
        <option value="">— Seleccionar tipo —</option>
        <option value="material">Incidencia que necesita material</option>
        <option value="documentacion">Modificar documentación</option>
        <option value="equipo">Resolver por equipo sin material</option>
      </select>
    </div>

    <!-- BLOQUE 4 DINÁMICO -->
    <div id="bloque-dinamico"></div>

    <button class="action-btn primary-action" onclick="validarIncidencia()" id="btn-validar-inc">
      <span>VALIDAR INCIDENCIA</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 6L9 17l-5-5"/>
      </svg>
    </button>

    <button class="action-btn secondary-action" onclick="finalizarIncidencias()">
      <span>NO HAY MÁS INCIDENCIAS, CONTINUAR</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</div>

<!-- ===== PANTALLA 5: RESUMEN INCIDENCIAS ===== -->
<div id="screen-resumen" class="screen">
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-incidencia')">‹</button>
    <div class="topbar-title">RESUMEN CFO</div>
    <div class="topbar-right"></div>
  </div>
  <div class="screen-body">
    <div class="resumen-header">
      <div class="resumen-stat">
        <div class="stat-num" id="stat-total">0</div>
        <div class="stat-label">Incidencias</div>
      </div>
      <div class="resumen-stat">
        <div class="stat-num" id="stat-material">0</div>
        <div class="stat-label">Con material</div>
      </div>
      <div class="resumen-stat">
        <div class="stat-num" id="stat-equipo">0</div>
        <div class="stat-label">Sin material</div>
      </div>
    </div>

    <div id="resumen-list" class="resumen-list"></div>

    <div class="send-actions">
      <button class="action-btn" onclick="exportarDatosJSON()" style="background:var(--surface2);border:1px solid var(--accent-green);color:var(--accent-green)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        <span>GUARDAR PROGRESO .JSON</span>
      </button>

      <button class="action-btn primary-action" id="btn-generar-pdf" onclick="generarPDF()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
          <polyline points="14,2 14,8 20,8"/>
          <line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        <span>GENERAR Y GUARDAR INFORME PDF</span>
      </button>

      <button class="action-btn email-action" id="btn-enviar-email" style="display:none" onclick="showEmailModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        <span>ENVIAR POR EMAIL</span>
      </button>

      <button class="action-btn volver-inicio-btn" id="btn-volver-inicio" style="display:none" onclick="volverAlInicio()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
          <polyline points="9,22 9,12 15,12 15,22"/>
        </svg>
        <span>VOLVER AL INICIO</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal enviar email -->
<div id="modal-email" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <div class="modal-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;display:inline;vertical-align:middle;margin-right:8px">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </svg>
      ENVIAR INFORME POR EMAIL
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">Email destinatario <span class="req">*</span></label>
        <input type="email" id="email-dest-modal" class="form-input" placeholder="destinatario@empresa.com">
      </div>
      <div class="form-group">
        <label class="form-label">CC (opcional)</label>
        <input type="email" id="email-cc-modal" class="form-input" placeholder="copia@empresa.com">
      </div>
      <div class="form-group">
        <label class="form-label">Asunto</label>
        <input type="text" id="email-subject-modal" class="form-input" placeholder="Informe CFO">
      </div>
      <div class="form-group">
        <label class="form-label">Mensaje adicional</label>
        <textarea id="email-msg-modal" class="form-textarea" rows="3" placeholder="Adjunto informe de la visita CFO..."></textarea>
      </div>
      <div id="email-pdf-url-row" style="display:none" class="cloud-folder-info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;flex-shrink:0">
          <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
        </svg>
        <div style="font-size:12px">
          <div style="color:var(--text3);font-size:10px;letter-spacing:1px;font-weight:600">PDF EN DROPBOX</div>
          <div id="email-pdf-url-text" class="cloud-folder-name" style="font-size:11px;word-break:break-all"></div>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeEmailModal()">CANCELAR</button>
      <button class="modal-btn confirm" onclick="enviarEmail()">
        <span id="email-btn-text">ENVIAR</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal editar incidencia -->
<div id="modal-edit" class="modal-overlay" style="display:none">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Editar Incidencia</div>
    <div id="modal-content" class="modal-content"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">CANCELAR</button>
      <button class="modal-btn confirm" onclick="saveModalEdit()">GUARDAR</button>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>

<!-- Loading overlay -->
<div id="loading" class="loading-overlay" style="display:none">
  <div class="loading-box">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">Procesando...</div>
  </div>
</div>

<script>
/* ===================================================
   AUTH · USUARIOS · MAPA — ROURA CEVASA v8
   =================================================== */

// ── CIUDADES ESPAÑA (coordenadas en el viewBox 80,60 → 660,480) ──
const SPAIN_CITIES = [
  {name:'Madrid',    x:380, y:230},
  {name:'Barcelona', x:545, y:140},
  {name:'Valencia',  x:476, y:310},
  {name:'Sevilla',   x:235, y:345},
  {name:'Zaragoza',  x:472, y:168},
  {name:'Málaga',    x:298, y:378},
  {name:'Murcia',    x:502, y:338},
  {name:'Bilbao',    x:345, y:108},
  {name:'Valladolid',x:285, y:178},
  {name:'Alicante',  x:505, y:326},
  {name:'Córdoba',   x:318, y:356},
  {name:'Granada',   x:355, y:378},
  {name:'Pamplona',  x:432, y:115},
  {name:'Santander', x:298, y:100},
  {name:'A Coruña',  x:158, y:108},
  {name:'Palma',     x:595, y:292},
  {name:'Las Palmas',x:140, y:430},
];

const USERS_KEY = 'roura_cfo_users';
const SESSION_KEY = 'roura_cfo_session';
let currentSession = null;
let mapRefreshInterval = null;
let editingUserModal = null;

// ═══════════════════════════════════════════════════════════════════
//  STORAGE DE USUARIOS — Dropbox primario + window.storage fallback
//
//  Prioridad:
//   1. Dropbox  (/ROURA_CFO/_SISTEMA_USUARIOS/usuarios.json)
//      → fuente de verdad compartida entre todos los dispositivos
//   2. window.storage (claude.ai) → caché local / modo offline
//
//  La sincronización es transparente: el admin no necesita hacer nada.
// ═══════════════════════════════════════════════════════════════════

const DEFAULT_USERS = () => [{
  username: 'admin', password: 'admin123', fullname: 'Administrador',
  role: 'admin', online: false, lastSeen: Date.now(), created: Date.now(),
  location: { city: 'Madrid', x: 380, y: 230, updated: Date.now() }
}];

async function loadUsers() {
  // 1. Intentar cargar desde Dropbox si hay token
  if (dbxToken) {
    try {
      const users = await dbxDownloadUsers();
      if (users && users.length > 0) {
        // Actualizar caché local
        try { await window.storage.set(USERS_KEY, JSON.stringify(users)); } catch(e) {}
        return users;
      }
    } catch(e) {
      console.warn('loadUsers: Dropbox falló, usando caché local:', e.message);
    }
  }
  // 2. Fallback: caché local (window.storage)
  try {
    const r = await window.storage.get(USERS_KEY);
    if (r) return JSON.parse(r.value);
  } catch(e) {}
  // 3. Defaults si no hay nada
  const defaults = DEFAULT_USERS();
  await saveUsers(defaults);
  return defaults;
}

async function saveUsers(users) {
  // Guardar siempre en caché local primero (instantáneo)
  try { await window.storage.set(USERS_KEY, JSON.stringify(users)); } catch(e) {}
  // Sincronizar con Dropbox en segundo plano si hay token
  if (dbxToken) {
    dbxSyncUsersToDropbox(users).catch(e =>
      console.warn('saveUsers: sync Dropbox falló:', e.message)
    );
  }
}

// Descarga el fichero de usuarios desde Dropbox
async function dbxDownloadUsers() {
  const token = await ensureValidToken();
  const resp = await fetch(`${DBX_CONTENT}/files/download`, {
    method: 'POST',
    headers: {
      'Authorization':   `Bearer ${token}`,
      'Dropbox-API-Arg': JSON.stringify({ path: DBX_USERS_FILE }),
    },
  });
  if (!resp.ok) {
    // Si el archivo no existe aún, no es error — devuelve null
    if (resp.status === 409) return null;
    throw new Error(`HTTP ${resp.status}`);
  }
  const text = await resp.text();
  return JSON.parse(text);
}

// Sube el fichero de usuarios a Dropbox (crea carpeta si no existe)
async function dbxSyncUsersToDropbox(users) {
  if (!dbxToken) return;
  // Asegurar que la carpeta de sistema existe
  await dbxCreateFolderSilent(DBX_SISTEMA_DIR);
  // Subir fichero de usuarios
  const payload = JSON.stringify({
    _tipo:        'ROURA_CFO_USUARIOS_V1',
    actualizadoEn: new Date().toISOString(),
    version:      '1.0',
    usuarios:     users.map(u => ({
      ...u,
      // No incluir el password en texto plano en el log público,
      // pero sí en el fichero principal (acceso restringido a la cuenta Dropbox)
    })),
  }, null, 2);
  await dbxUploadBlob(
    new Blob([payload], { type: 'application/json' }),
    DBX_USERS_FILE
  );
}

// Registra un acceso en el log de Dropbox (sin bloquear)
async function dbxRegistrarAcceso(username, accion) {
  if (!dbxToken) return;
  try {
    await dbxCreateFolderSilent(DBX_SISTEMA_DIR);
    // Descargar log existente o crear vacío
    let log = [];
    try {
      const token = await ensureValidToken();
      const r = await fetch(`${DBX_CONTENT}/files/download`, {
        method: 'POST',
        headers: {
          'Authorization':   `Bearer ${token}`,
          'Dropbox-API-Arg': JSON.stringify({ path: DBX_ACCESOS_FILE }),
        },
      });
      if (r.ok) log = JSON.parse(await r.text());
    } catch(e) {}
    // Añadir entrada
    log.push({
      ts:       new Date().toISOString(),
      usuario:  username,
      accion,
      ua:       navigator.userAgent.substring(0,80),
    });
    // Mantener sólo los últimos 500 registros
    if (log.length > 500) log = log.slice(-500);
    await dbxUploadBlob(
      new Blob([JSON.stringify(log, null, 2)], { type: 'application/json' }),
      DBX_ACCESOS_FILE
    );
  } catch(e) {
    console.warn('dbxRegistrarAcceso error:', e.message);
  }
}

// Versión silenciosa de dbxCreateFolder (no lanza si falla)
async function dbxCreateFolderSilent(path) {
  try { await dbxCreateFolder(path); } catch(e) {}
}
async function loadSession() {
  try {
    const r = await window.storage.get(SESSION_KEY);
    return r ? JSON.parse(r.value) : null;
  } catch(e) { return null; }
}
async function setSession(data) {
  try { await window.storage.set(SESSION_KEY, JSON.stringify(data)); } catch(e) {}
}
async function clearSession() {
  try { await window.storage.delete(SESSION_KEY); } catch(e) {}
}

// ── LOGIN ──
async function doLogin() {
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  if (!u || !p) { errEl.textContent = 'Introduce usuario y contraseña'; errEl.style.display = 'block'; return; }
  const users = await loadUsers();
  const found = users.find(x => x.username === u && x.password === p);
  if (!found) { errEl.textContent = 'Usuario o contraseña incorrectos'; errEl.style.display = 'block'; return; }

  // Actualizar estado online + ubicación aleatoria si no tiene
  found.online = true;
  found.lastSeen = Date.now();
  if (!found.location) {
    const city = SPAIN_CITIES[Math.floor(Math.random() * SPAIN_CITIES.length)];
    found.location = { city: city.name, x: city.x + (Math.random()-0.5)*15, y: city.y + (Math.random()-0.5)*15, updated: Date.now() };
  }
  await saveUsers(users);
  await setSession({ username: found.username, role: found.role, fullname: found.fullname });
  currentSession = { ...found };
  // Registrar acceso en log Dropbox (en segundo plano, no bloquea)
  dbxRegistrarAcceso(found.username, 'LOGIN').catch(() => {});
  onLoginSuccess(found);
}

function onLoginSuccess(user) {
  // Rellena nombre ingeniero automáticamente si está vacío
  const ingEl = document.getElementById('nombre-ingeniero');
  if (ingEl && !ingEl.value) ingEl.value = user.fullname;

  // Muestra botón admin si es admin
  const adminBtn = document.getElementById('btn-admin-menu');
  if (adminBtn) adminBtn.style.display = user.role === 'admin' ? 'flex' : 'none';

  // Actualiza etiqueta usuario en pantalla principal
  const lbl = document.getElementById('main-user-label');
  if (lbl) lbl.textContent = (user.fullname || user.username).toUpperCase() + ' · ' + (user.role === 'admin' ? 'ADMIN' : 'TÉCNICO');

  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('login-error').style.display = 'none';

  const permisosYaSolicitados = localStorage.getItem('roura_permisos_solicitados');
  if (!permisosYaSolicitados) {
    mostrarPantallaPermisos(results => {
      goTo('screen-main');
      iniciarActualizacionUbicacion();
    });
  } else {
    goTo('screen-main');
    // Actualizar ubicación real en segundo plano
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => updateUserRealLocation(pos.coords.latitude, pos.coords.longitude),
        () => {},
        { enableHighAccuracy: true, timeout: 8000 }
      );
      iniciarActualizacionUbicacion();
    }
  }
}

async function doLogout() {
  if (currentSession) {
    const users = await loadUsers();
    const u = users.find(x => x.username === currentSession.username);
    if (u) { u.online = false; u.lastSeen = Date.now(); await saveUsers(users); }
    dbxRegistrarAcceso(currentSession.username, 'LOGOUT').catch(() => {});
  }
  await clearSession();
  currentSession = null;
  if (mapRefreshInterval) { clearInterval(mapRefreshInterval); mapRefreshInterval = null; }
  goTo('screen-login');
}

async function driftLocation(username) {
  const users = await loadUsers();
  const u = users.find(x => x.username === username);
  if (!u || !u.online || !u.location) return;
  u.location.x = Math.max(105, Math.min(620, u.location.x + (Math.random()-0.5)*10));
  u.location.y = Math.max(80, Math.min(460, u.location.y + (Math.random()-0.5)*10));
  u.location.updated = Date.now();
  await saveUsers(users);
}

// ── ADMIN: USUARIOS ──
async function adminCreateUser() {
  const fullname = document.getElementById('new-fullname').value.trim();
  const username = document.getElementById('new-username').value.trim();
  const password = document.getElementById('new-password').value;
  const role = document.getElementById('new-role').value;
  const msgEl = document.getElementById('admin-msg');

  if (!fullname || !username || !password) { msgEl.style.color='var(--accent-red)'; msgEl.textContent = '✗ Rellena todos los campos obligatorios'; return; }
  if (password.length < 6) { msgEl.style.color='var(--accent-red)'; msgEl.textContent = '✗ La contraseña debe tener mínimo 6 caracteres'; return; }

  const users = await loadUsers();
  if (users.find(u => u.username === username)) { msgEl.style.color='var(--accent-red)'; msgEl.textContent = '✗ Ese nombre de usuario ya existe'; return; }

  const city = SPAIN_CITIES[Math.floor(Math.random() * SPAIN_CITIES.length)];
  users.push({
    username, password, fullname, role, online: false,
    lastSeen: Date.now(), created: Date.now(),
    location: { city: city.name, x: city.x + (Math.random()-0.5)*15, y: city.y + (Math.random()-0.5)*15, updated: Date.now() }
  });
  await saveUsers(users);
  msgEl.style.color='var(--accent-green)';
  msgEl.textContent = '✓ Usuario "' + username + '" creado. Sincronizando con Dropbox...';
  // Indicador visual Dropbox
  if (dbxToken) {
    setTimeout(async () => {
      try {
        await dbxSyncUsersToDropbox(users);
        msgEl.textContent = '✓ Usuario "' + username + '" creado y guardado en Dropbox ✓';
      } catch(e) {
        msgEl.textContent = '✓ Usuario creado (local). Conecta Dropbox para sincronizar.';
      }
    }, 200);
  } else {
    msgEl.textContent = '✓ Usuario "' + username + '" creado (Dropbox no conectado)';
  }
  document.getElementById('new-fullname').value = '';
  document.getElementById('new-username').value = '';
  document.getElementById('new-password').value = '';
  renderAdminUsersList();
  setTimeout(() => { msgEl.textContent = ''; }, 5000);
}

async function renderAdminUsersList() {
  const users = await loadUsers();
  const container = document.getElementById('admin-users-list');
  container.innerHTML = '';
  users.forEach(u => {
    const div = document.createElement('div');
    div.className = 'user-row';
    div.innerHTML = `
      <div class="user-row-avatar">${(u.fullname || u.username)[0].toUpperCase()}</div>
      <div class="user-row-info">
        <div class="user-row-name">${u.fullname || u.username}</div>
        <div class="user-row-role">${u.role === 'admin' ? '★ Administrador' : 'Técnico'} · @${u.username}</div>
        <div class="user-row-online ${u.online?'on':'off'}">${u.online ? '● En línea' : '○ Desconectado'}</div>
      </div>
      <div class="user-row-actions">
        <button class="icon-btn" onclick="openUserModal('${u.username}')" title="Editar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        ${u.username !== 'admin' ? `<button class="icon-btn del" onclick="deleteUser('${u.username}')" title="Eliminar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>` : ''}
      </div>`;
    container.appendChild(div);
  });
}

async function deleteUser(username) {
  if (!confirm('¿Eliminar al usuario "' + username + '"? Esta acción no se puede deshacer.')) return;
  let users = await loadUsers();
  users = users.filter(u => u.username !== username);
  await saveUsers(users);
  renderAdminUsersList();
  showToast(dbxToken ? '✓ Usuario eliminado y sincronizado en Dropbox' : '✓ Usuario eliminado', 'success');
  dbxRegistrarAcceso(currentSession?.username || 'admin', `DELETE_USER:${username}`).catch(() => {});
}

async function openUserModal(username) {
  editingUserModal = username;
  const users = await loadUsers();
  const u = users.find(x => x.username === username);
  if (!u) return;
  document.getElementById('modal-user-title').textContent = 'Editar: ' + u.fullname;
  document.getElementById('modal-user-content').innerHTML = `
    <div class="form-group" style="margin-bottom:14px">
      <label class="form-label">Nombre completo</label>
      <input type="text" id="modal-edit-fullname" class="form-input" value="${u.fullname || ''}">
    </div>
    <div class="form-group" style="margin-bottom:14px">
      <label class="form-label">Nueva contraseña <span style="color:var(--text3)">(dejar vacío para no cambiar)</span></label>
      <input type="password" id="modal-edit-pwd" class="form-input" placeholder="Nueva contraseña">
    </div>
    <div class="form-group">
      <label class="form-label">Rol</label>
      <select id="modal-edit-role" class="form-select">
        <option value="user" ${u.role==='user'?'selected':''}>Técnico / Usuario</option>
        <option value="admin" ${u.role==='admin'?'selected':''}>Administrador</option>
      </select>
    </div>`;
  document.getElementById('modal-user').style.display = 'flex';
}
function closeUserModal() { document.getElementById('modal-user').style.display = 'none'; }

async function saveUserModal() {
  const users = await loadUsers();
  const u = users.find(x => x.username === editingUserModal);
  if (!u) return;
  const fn = document.getElementById('modal-edit-fullname').value.trim();
  const pwd = document.getElementById('modal-edit-pwd').value;
  const role = document.getElementById('modal-edit-role').value;
  if (fn) u.fullname = fn;
  if (pwd && pwd.length >= 6) u.password = pwd;
  u.role = role;
  await saveUsers(users);
  closeUserModal();
  renderAdminUsersList();
  showToast(dbxToken ? '✓ Usuario actualizado y sincronizado en Dropbox' : '✓ Usuario actualizado', 'success');
  dbxRegistrarAcceso(currentSession?.username || 'admin', `EDIT_USER:${editingUserModal}`).catch(() => {});
}

// ════════════════════════════════════════════════════════════════════
//  SINCRONIZACIÓN DROPBOX — USUARIOS (Panel Administrador)
// ════════════════════════════════════════════════════════════════════

async function updateAdminDropboxStatus() {
  const dot = document.getElementById('admin-dbx-dot');
  const lbl = document.getElementById('admin-dbx-lbl');
  const btn = document.getElementById('btn-admin-dropbox-link');
  if (!dot || !lbl) return;

  if (!dbxToken) {
    dot.style.background = '#E84040';
    lbl.textContent = 'Dropbox no conectado — los usuarios solo se guardan en este dispositivo';
    if (btn) btn.style.display = 'none';
    return;
  }

  dot.style.background = '#F5A623';
  lbl.textContent = 'Comprobando sincronización con Dropbox...';
  if (btn) btn.style.display = 'inline-flex';

  try {
    const remote = await dbxDownloadUsers();
    if (remote && remote.length > 0) {
      dot.style.background = '#20C060';
      lbl.textContent = `✓ Dropbox activo · ${remote.length} usuarios · ${DBX_USERS_FILE}`;
    } else {
      // Archivo no existe aún → sincronizar
      const local = await loadUsers();
      await dbxSyncUsersToDropbox(local);
      dot.style.background = '#20C060';
      lbl.textContent = `✓ Usuarios guardados en Dropbox (${local.length} usuarios)`;
    }
  } catch(e) {
    dot.style.background = '#F5A623';
    lbl.textContent = `⚠ Dropbox conectado pero sin acceso: ${e.message}`;
  }
}

async function dbxSyncManual() {
  const dot = document.getElementById('admin-dbx-dot');
  const lbl = document.getElementById('admin-dbx-lbl');
  if (!dbxToken) {
    showToast('Conecta Dropbox primero desde Configuración', 'error');
    return;
  }
  if (dot) dot.style.background = '#F5A623';
  if (lbl) lbl.textContent = 'Sincronizando...';
  try {
    const users = await loadUsers();
    await dbxSyncUsersToDropbox(users);
    if (dot) dot.style.background = '#20C060';
    if (lbl) lbl.textContent = `✓ Sincronizado · ${users.length} usuarios en Dropbox`;
    showToast(`✓ ${users.length} usuarios guardados en Dropbox`, 'success');
  } catch(e) {
    if (dot) dot.style.background = '#E84040';
    if (lbl) lbl.textContent = `✗ Error: ${e.message}`;
    showToast('Error sincronizando con Dropbox: ' + e.message, 'error');
  }
}

function abrirCarpetaUsuariosDropbox() {
  // Construir URL directa a la carpeta de sistema en Dropbox
  const url = `https://www.dropbox.com/home${encodeURIComponent(DBX_SISTEMA_DIR)}`;
  window.open(url, '_blank');
}

// ── MAPA ──
async function renderMapa() {
  const users = await loadUsers();
  const markersDiv = document.getElementById('map-markers');
  const listDiv = document.getElementById('map-users-list');
  const svgEl = document.getElementById('spain-svg');
  if (!markersDiv || !svgEl) return;

  markersDiv.innerHTML = '';
  // Actualizar lista
  let listHTML = '<div style="font-size:11px;color:var(--text3);letter-spacing:1px;font-family:var(--font-cond);font-weight:700;margin-bottom:4px">USUARIOS CONECTADOS</div>';

  const svgRect = svgEl.getBoundingClientRect();
  const viewBox = {x:80, y:60, w:580, h:420};

  users.filter(u => u.location).forEach(u => {
    const pctX = ((u.location.x - viewBox.x) / viewBox.w) * 100;
    const pctY = ((u.location.y - viewBox.y) / viewBox.h) * 100;

    const pin = document.createElement('div');
    pin.className = 'map-user-marker';
    pin.style.left = pctX + '%';
    pin.style.top = pctY + '%';
    pin.style.pointerEvents = 'auto';
    pin.innerHTML = `
      <div class="map-label" style="${u.location.isReal?'border-color:var(--accent-green);color:var(--accent-green)':''}">${u.fullname || u.username}${u.location.isReal?' 📍':''}</div>
      <div class="map-pin ${u.online?'':'offline'}" style="${u.location.isReal?'background:var(--accent-green);box-shadow:0 0 0 3px rgba(32,192,96,.3),0 0 10px rgba(32,192,96,.5)':''}"></div>`;
    markersDiv.appendChild(pin);

    const ago = Math.round((Date.now() - u.location.updated) / 60000);
    const gpsIcon = u.location.isReal ? '📍' : '📌';
    listHTML += `<div class="map-user-item">
      <div class="map-user-dot ${u.online?'on':'off'}"></div>
      <div style="flex:1">
        <span style="font-weight:600;color:var(--text)">${u.fullname||u.username}</span>
        <span style="color:var(--text3)"> · ${gpsIcon} ${u.location.city}</span>
        ${u.location.isReal ? '<span style="font-size:10px;color:var(--accent-green);margin-left:4px">GPS REAL</span>' : ''}
      </div>
      <span style="font-size:11px;color:var(--text3)">${ago === 0 ? 'Ahora' : 'Hace '+ago+'min'}</span>
    </div>`;
  });
  listDiv.innerHTML = listHTML;
}

function startMapRefresh() {
  renderMapa();
  if (mapRefreshInterval) clearInterval(mapRefreshInterval);
  mapRefreshInterval = setInterval(renderMapa, 12000);
}

// ── INIT ──
(async function initApp() {
  const sess = await loadSession();
  if (sess) {
    const users = await loadUsers();
    const u = users.find(x => x.username === sess.username);
    if (u) {
      u.online = true; u.lastSeen = Date.now();
      if (!u.location) {
        const city = SPAIN_CITIES[Math.floor(Math.random()*SPAIN_CITIES.length)];
        u.location = {city:city.name,x:city.x+(Math.random()-0.5)*15,y:city.y+(Math.random()-0.5)*15,updated:Date.now()};
      }
      await saveUsers(users);
      currentSession = { ...u };
      onLoginSuccess(u);
      return;
    }
  }
  // Mostrar login
  goTo('screen-login');
})();

// Enter en login
document.addEventListener('DOMContentLoaded', () => {
  const pwdInput = document.getElementById('login-password');
  if (pwdInput) pwdInput.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  const userInput = document.getElementById('login-username');
  if (userInput) userInput.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
});

// ═══════════════════════════════════════════════════════════
//  PERMISOS AL INICIO — solicitar mic + geolocalizacion
// ═══════════════════════════════════════════════════════════
async function solicitarPermisos() {
  const results = { geo: false, mic: false };

  // Geolocalización
  await new Promise(resolve => {
    if (!navigator.geolocation) { resolve(); return; }
    navigator.geolocation.getCurrentPosition(
      pos => {
        results.geo = true;
        // Guardar coords reales para el mapa del admin
        if (currentSession) updateUserRealLocation(pos.coords.latitude, pos.coords.longitude);
        resolve();
      },
      () => resolve(),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });

  // Micrófono
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    results.mic = true;
    stream.getTracks().forEach(t => t.stop());
  } catch(e) { /* denegado */ }

  return results;
}

async function updateUserRealLocation(lat, lon) {
  if (!currentSession) return;
  const users = await loadUsers();
  const u = users.find(x => x.username === currentSession.username);
  if (!u) return;

  // Convertir coords reales (lat/lon España) → coordenadas del SVG viewBox (80,60 → 660,480)
  // España bbox: lon -9.3..4.3 lat 35.9..43.8
  const minLon = -9.5, maxLon = 4.5, minLat = 35.7, maxLat = 43.9;
  const svgMinX = 100, svgMaxX = 650, svgMinY = 75, svgMaxY = 460;

  let svgX = svgMinX + ((lon - minLon) / (maxLon - minLon)) * (svgMaxX - svgMinX);
  let svgY = svgMinY + ((maxLat - lat) / (maxLat - minLat)) * (svgMaxY - svgMinY);

  // Clamp inside bounds
  svgX = Math.max(svgMinX, Math.min(svgMaxX, svgX));
  svgY = Math.max(svgMinY, Math.min(svgMaxY, svgY));

  // Reverse geocode para nombre de ciudad
  let cityName = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
    const d = await r.json();
    cityName = d.address?.city || d.address?.town || d.address?.village || d.address?.county || cityName;
  } catch(e) {}

  u.location = { city: cityName, x: svgX, y: svgY, lat, lon, updated: Date.now(), isReal: true };
  await saveUsers(users);

  // Actualizar campo ubicación si está vacío
  const ubicEl = document.getElementById('ubicacion');
  if (ubicEl && !ubicEl.value) ubicEl.value = cityName;
}

// Actualizar ubicación real periódicamente (cada 60s)
function iniciarActualizacionUbicacion() {
  if (!navigator.geolocation) return;
  setInterval(() => {
    navigator.geolocation.getCurrentPosition(
      pos => { if (currentSession) updateUserRealLocation(pos.coords.latitude, pos.coords.longitude); },
      () => {},
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }, 60000);
}

// ═══════════════════════════════════════════════════════════
//  PANTALLA PERMISOS (se muestra en el primer login)
// ═══════════════════════════════════════════════════════════
let permisosOtorgados = false;

function mostrarPantallaPermisos(callback) {
  // Crear overlay de permisos
  const overlay = document.createElement('div');
  overlay.id = 'permisos-overlay';
  overlay.style.cssText = `
    position:fixed;inset:0;z-index:9999;
    background:rgba(10,22,40,0.97);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:32px;max-width:480px;margin:0 auto;
  `;
  overlay.innerHTML = `
    <div style="text-align:center;max-width:340px">
      <div style="font-size:48px;margin-bottom:16px">🔐</div>
      <div style="font-family:var(--font-cond);font-size:22px;font-weight:800;letter-spacing:2px;color:var(--text);margin-bottom:8px">PERMISOS NECESARIOS</div>
      <div style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:28px">
        Esta aplicación necesita tu permiso para funcionar correctamente:
      </div>
      <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:28px;text-align:left">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px">
          <span style="font-size:24px">📍</span>
          <div>
            <div style="font-family:var(--font-cond);font-size:14px;font-weight:700;color:var(--text)">GEOLOCALIZACIÓN</div>
            <div style="font-size:12px;color:var(--text2)">Para registrar tu ubicación en el mapa y en los informes</div>
          </div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px">
          <span style="font-size:24px">🎤</span>
          <div>
            <div style="font-family:var(--font-cond);font-size:14px;font-weight:700;color:var(--text)">MICRÓFONO</div>
            <div style="font-size:12px;color:var(--text2)">Para dictar descripciones e incidencias por voz</div>
          </div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px">
          <span style="font-size:24px">📷</span>
          <div>
            <div style="font-family:var(--font-cond);font-size:14px;font-weight:700;color:var(--text)">CÁMARA / ARCHIVOS</div>
            <div style="font-size:12px;color:var(--text2)">Para adjuntar fotografías a las incidencias</div>
          </div>
        </div>
      </div>
      <button id="btn-aceptar-permisos" style="
        width:100%;background:var(--accent);border:none;border-radius:10px;
        padding:16px;color:white;font-family:var(--font-cond);font-size:17px;
        font-weight:800;letter-spacing:1.5px;cursor:pointer;
      ">ACEPTAR Y CONTINUAR</button>
      <div style="margin-top:12px;font-size:11px;color:var(--text3)">
        Puedes revocar estos permisos en cualquier momento desde la configuración de tu navegador.
      </div>
    </div>`;

  document.body.appendChild(overlay);

  document.getElementById('btn-aceptar-permisos').addEventListener('click', async () => {
    document.getElementById('btn-aceptar-permisos').textContent = 'Solicitando permisos...';
    document.getElementById('btn-aceptar-permisos').disabled = true;
    const results = await solicitarPermisos();
    permisosOtorgados = true;
    localStorage.setItem('roura_permisos_solicitados', '1');
    overlay.remove();
    iniciarActualizacionUbicacion();
    callback(results);
  });
}

// ═══════════════════════════════════════════════════════════
//  CARGAR VISITA JSON EXISTENTE
// ═══════════════════════════════════════════════════════════
function triggerCargarJSON() {
  document.getElementById('cargar-visita-input').value = '';
  document.getElementById('cargar-visita-input').click();
}

function cargarVisitaJSON(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data._tipo || data._tipo !== 'ROURA_CFO_DATOS_V1') {
        showToast('❌ Archivo no válido. Usa el .json generado por esta app.', 'error');
        return;
      }
      // Restaurar estado completo
      state.datosInstalacion = data.datosInstalacion || {};
      state.numPedido        = data.numPedido || '';
      state.incidencias      = data.incidencias || [];

      // Rellenar formulario datos instalación
      const m = state.datosInstalacion;
      const set = (id, val) => { const el = document.getElementById(id); if(el && val) el.value = val; };
      set('num-pedido',           m.numPedido);
      set('punto-abanderamiento', m.puntoAbanderamiento);
      set('fecha-visita',         m.fecha);
      set('ubicacion',            m.ubicacion);
      set('nombre-ingeniero',     m.nombreIngeniero);
      set('tel-ingeniero',        m.telIngeniero);
      set('email-ingeniero',      m.emailIngeniero);

      showToast(`✓ Informe cargado: ${state.incidencias.length} incidencias`, 'success');
      renderResumen();
      goTo('screen-resumen');
    } catch(err) {
      showToast('❌ Error leyendo el archivo JSON: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
}

// ═══════════════════════════════════════════════════════════
//  CARGAR CIERRE JSON EXISTENTE
// ═══════════════════════════════════════════════════════════
function triggerCargarCierreJSON() {
  document.getElementById('cargar-cierre-file').value = '';
  document.getElementById('cargar-cierre-file').click();
}

function cargarCierreExistente(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data._tipo || data._tipo !== 'ROURA_CFO_CIERRE_V1') {
        showToast('❌ Archivo no válido. Usa el .json de cierre generado por esta app.', 'error');
        return;
      }
      cierreState.datosInforme = data.datosInforme || {};
      cierreState.incidencias  = data.incidencias  || [];
      cierreState.cierres      = data.cierres || cierreState.incidencias.map(() => ({ fotos:[], comentario:'', cerrada:false }));

      // Mostrar info del informe cargado
      document.getElementById('cierre-load-zone').style.display   = 'none';
      document.getElementById('cierre-loaded-card').style.display = 'block';
      document.getElementById('btn-iniciar-cierre').style.display = 'flex';
      const d = cierreState.datosInforme.datosInstalacion || {};
      document.getElementById('cierre-pedido-label').textContent = `Pedido: ${cierreState.datosInforme.numPedido || '—'}`;
      document.getElementById('cierre-meta-label').textContent   = `${d.puntoAbanderamiento || '—'} · ${cierreState.incidencias.length} incidencias · ${cierreState.cierres.filter(c=>c.cerrada).length} cerradas`;

      showToast(`✓ Cierre cargado: ${cierreState.incidencias.length} incidencias`, 'success');
    } catch(err) {
      showToast('❌ Error leyendo el archivo: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
}

// ═══════════════════════════════════════════════════════════
//  GUARDAR CIERRE JSON
// ═══════════════════════════════════════════════════════════
function guardarCierreJSON() {
  try {
    if (!cierreState.datosInforme) { showToast('No hay cierre activo para guardar', 'error'); return; }
    const exportData = {
      _tipo:       'ROURA_CFO_CIERRE_V1',
      exportadoEn: new Date().toISOString(),
      datosInforme: cierreState.datosInforme,
      incidencias: cierreState.incidencias,
      cierres:     cierreState.cierres,
    };
    const pedido  = cierreState.datosInforme.numPedido || 'cierre';
    const jsonStr = JSON.stringify(exportData, null, 2);
    const blob    = new Blob([jsonStr], { type: 'application/json' });
    const url     = URL.createObjectURL(blob);
    const a       = document.createElement('a');
    a.href        = url;
    a.download    = `${pedido} Cierre CFO.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('✓ Cierre guardado como .json', 'success');
  } catch(e) {
    showToast('Error al guardar: ' + e.message, 'error');
  }
}

</script>

<script>
/* ===================================================
   ROURA CEVASA CFO APP · JAVASCRIPT
   =================================================== */

// ======== STATE ========
const LOGO_B64 = 'data:image/jpeg;base64,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';
let state = {
  datosInstalacion: {},
  incidencias: [],
  incidenciaActual: null,
  numPedido: '',
  incidenciaIndex: 0,   // 0-based, la que se está editando en resumen
  modoEdicion: false,
  recognition: null,
  audioTarget: null,
  fotos: [],           // fotos incidencia actual
  fotosCroquis: []     // fotos croquis material actual
};

// ======== NAVEGACIÓN ========
function goTo(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById(screenId);
  if (!screen) return;
  screen.classList.add('active');
  screen.scrollTop = 0;
  if (screenId === 'screen-admin') {
    renderAdminUsersList();
    setTimeout(updateAdminDropboxStatus, 300);
  }
  if (screenId === 'screen-mapa') startMapRefresh();
  if (screenId !== 'screen-mapa' && mapRefreshInterval) { clearInterval(mapRefreshInterval); mapRefreshInterval = null; }
}

// ======== INIT DATE + CONFIG ========
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById('fecha-visita').value = `${yyyy}-${mm}-${dd}`;
  loadConfig();
});

// ======== GEOLOCALIZACIÓN ========
function getLocation() {
  const status = document.getElementById('geo-status');
  const input = document.getElementById('ubicacion');
  status.textContent = '⟳ Obteniendo ubicación...';
  if (!navigator.geolocation) {
    status.textContent = '✗ Geolocalización no disponible';
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      input.value = `${lat}, ${lon}`;
      status.textContent = `✓ Ubicación obtenida (±${Math.round(pos.coords.accuracy)}m)`;
      // Actualizar mapa admin con ubicación real
      if (typeof updateUserRealLocation === 'function') {
        updateUserRealLocation(pos.coords.latitude, pos.coords.longitude);
      }
      // Reverse geocode via free API
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(r => r.json())
        .then(d => {
          if (d.display_name) {
            input.value = d.display_name;
            status.textContent = `✓ ${lat}, ${lon}`;
          }
        }).catch(() => {});
    },
    err => {
      status.textContent = '✗ No se pudo obtener la ubicación. Introduce manualmente.';
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

// ======== VALIDAR DATOS INSTALACIÓN ========
function validarDatos() {
  const fields = [
    { id: 'num-pedido', label: 'Número de Pedido' },
    { id: 'punto-abanderamiento', label: 'Punto de Abanderamiento' },
    { id: 'fecha-visita', label: 'Fecha' },
    { id: 'ubicacion', label: 'Ubicación' },
    { id: 'nombre-ingeniero', label: 'Nombre del Ingeniero' },
    { id: 'tel-ingeniero', label: 'Teléfono del Ingeniero' },
    { id: 'email-ingeniero', label: 'Email del Ingeniero' },
  ];
  for (const f of fields) {
    const val = document.getElementById(f.id).value.trim();
    if (!val) { showToast(`El campo "${f.label}" es obligatorio`, 'error'); return; }
  }
  const email = document.getElementById('email-ingeniero').value.trim();
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showToast('Introduce un email válido', 'error'); return;
  }
  state.datosInstalacion = {
    numPedido: document.getElementById('num-pedido').value.trim(),
    puntoAbanderamiento: document.getElementById('punto-abanderamiento').value.trim(),
    fecha: document.getElementById('fecha-visita').value,
    ubicacion: document.getElementById('ubicacion').value.trim(),
    nombreIngeniero: document.getElementById('nombre-ingeniero').value.trim(),
    telIngeniero: document.getElementById('tel-ingeniero').value.trim(),
    emailIngeniero: document.getElementById('email-ingeniero').value.trim(),
  };
  state.numPedido = state.datosInstalacion.numPedido;
  state.incidencias = [];
  state.cloudInformeUrl = null;
  // Crear carpeta en Box en background (no bloquea la navegación)
  crearCarpetaCloudinary();
  iniciarNuevaIncidencia();
}

// ======== INCIDENCIAS ========
function iniciarNuevaIncidencia(datosPrev = null) {
  const numActual = datosPrev ? state.incidencias.indexOf(datosPrev) + 1 : state.incidencias.length + 1;
  state.fotos = datosPrev ? [...(datosPrev.fotos || [])] : [];
  state.fotosCroquis = datosPrev ? [...(datosPrev.fotosCroquis || [])] : [];
  state.incidenciaActual = datosPrev || null;
  state.modoEdicion = !!datosPrev;

  const codigo = generarCodigo(numActual);

  document.getElementById('incidencia-title').textContent = `INCIDENCIA #${String(numActual).padStart(3,'0')}`;
  document.getElementById('incidencia-counter').textContent = `${numActual}/50`;
  document.getElementById('codigo-incidencia').textContent = codigo;

  // Reset form
  document.getElementById('descripcion-incidencia').value = datosPrev ? (datosPrev.descripcion || '') : '';
  document.getElementById('tipo-incidencia').value = datosPrev ? (datosPrev.tipo || '') : '';
  document.getElementById('bloque-dinamico').innerHTML = '';

  renderFotos();

  if (datosPrev && datosPrev.tipo) {
    renderBloquesDinamicos(datosPrev.tipo, datosPrev);
  }

  goTo('screen-incidencia');

  // Mostrar barra de carpeta cloud si Box está conectado
  const folderBar  = document.getElementById('cloud-folder-bar');
  const folderName = document.getElementById('cloud-folder-name');
  if (folderBar && folderName && gDriveFolderId) {
    folderName.textContent = cloudFolder();
    folderBar.style.display = 'flex';
  } else if (folderBar) {
    folderBar.style.display = 'none';
  }

  // Pre-rellenar email destinatario con el email del ingeniero
  const destEl = document.getElementById('email-dest-modal');
  if (destEl && !destEl.value && state.datosInstalacion.emailIngeniero) {
    destEl.value = cfg.emailDest || state.datosInstalacion.emailIngeniero;
  }
}

function generarCodigo(num) {
  const pedido = state.numPedido.replace(/[^A-Z0-9]/gi, '').toUpperCase().slice(0, 10);
  const fecha = state.datosInstalacion.fecha ? state.datosInstalacion.fecha.replace(/-/g, '') : '00000000';
  return `${pedido}-INC-${String(num).padStart(3, '0')}-${fecha}`;
}

function handleTipoChange() {
  const tipo = document.getElementById('tipo-incidencia').value;
  renderBloquesDinamicos(tipo, null);
}

function renderBloquesDinamicos(tipo, datos) {
  const container = document.getElementById('bloque-dinamico');
  container.innerHTML = '';
  if (!tipo) return;

  if (tipo === 'material') {
    container.innerHTML = `
      <div class="block-card dynamic-block">
        <div class="block-header">
          <div class="block-num">04</div>
          <div class="block-title">FOTOGRAFÍAS CROQUIS DEL MATERIAL</div>
          <div class="block-count" id="croquis-count">0/15</div>
        </div>
        <div id="croquis-preview" class="fotos-grid"></div>
        <div class="foto-actions">
          <button class="foto-btn" onclick="triggerCameraC()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>Cámara
          </button>
          <button class="foto-btn" onclick="triggerGaleriaC()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21,15 16,10 5,21"/>
            </svg>Galería
          </button>
        </div>
        <input type="file" id="camera-input-c" accept="image/*" capture="environment" style="display:none" multiple onchange="handleFotosCroquis(this)">
        <input type="file" id="gallery-input-c" accept="image/*" style="display:none" multiple onchange="handleFotosCroquis(this)">
      </div>
      <div class="block-card dynamic-block">
        <div class="block-header">
          <div class="block-num">05</div>
          <div class="block-title">INFORMACIÓN DEL MATERIAL NECESARIO</div>
        </div>
        <textarea id="info-material" class="form-textarea" placeholder="Describe el material necesario, referencia, cantidad..." rows="4">${datos ? (datos.infoMaterial || '') : ''}</textarea>
        <button class="audio-btn" id="audio-material-btn" onclick="toggleAudio('info-material','audio-material-btn')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
            <path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4m-4 0h8"/>
          </svg>
          <span>Dictar información de material</span>
        </button>
      </div>`;
    renderFotosCroquis();
    if (datos && datos.fotosCroquis) { state.fotosCroquis = [...datos.fotosCroquis]; renderFotosCroquis(); }

  } else if (tipo === 'documentacion') {
    container.innerHTML = `
      <div class="block-card dynamic-block">
        <div class="block-header">
          <div class="block-num">04</div>
          <div class="block-title">MODIFICACIÓN DE DOCUMENTACIÓN</div>
        </div>
        <textarea id="desc-documentacion" class="form-textarea" placeholder="Describe qué documentación es necesario modificar y cómo..." rows="5">${datos ? (datos.descDocumentacion || '') : ''}</textarea>
        <button class="audio-btn" id="audio-doc-btn" onclick="toggleAudio('desc-documentacion','audio-doc-btn')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
            <path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4m-4 0h8"/>
          </svg>
          <span>Dictar modificaciones</span>
        </button>
      </div>`;

  } else if (tipo === 'equipo') {
    container.innerHTML = `
      <div class="block-card dynamic-block">
        <div class="block-header">
          <div class="block-num">04</div>
          <div class="block-title">TRABAJO A REALIZAR POR EQUIPO</div>
        </div>
        <textarea id="desc-equipo" class="form-textarea" placeholder="Describe el trabajo a realizar por el equipo sin necesidad de material..." rows="5">${datos ? (datos.descEquipo || '') : ''}</textarea>
        <button class="audio-btn" id="audio-equipo-btn" onclick="toggleAudio('desc-equipo','audio-equipo-btn')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
            <path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4m-4 0h8"/>
          </svg>
          <span>Dictar trabajo a realizar</span>
        </button>
      </div>`;
  }
}

function validarIncidencia() {
  const descripcion = document.getElementById('descripcion-incidencia').value.trim();
  const tipo = document.getElementById('tipo-incidencia').value;

  if (!descripcion) { showToast('La descripción de la incidencia es obligatoria', 'error'); return; }
  if (!tipo) { showToast('Selecciona el tipo de incidencia', 'error'); return; }

  let extraData = {};
  if (tipo === 'material') {
    const info = document.getElementById('info-material');
    if (!info || !info.value.trim()) { showToast('Introduce la información del material necesario', 'error'); return; }
    extraData.infoMaterial = info.value.trim();
    extraData.fotosCroquis = [...state.fotosCroquis];
  } else if (tipo === 'documentacion') {
    const desc = document.getElementById('desc-documentacion');
    if (!desc || !desc.value.trim()) { showToast('Describe qué documentación se debe modificar', 'error'); return; }
    extraData.descDocumentacion = desc.value.trim();
  } else if (tipo === 'equipo') {
    const desc = document.getElementById('desc-equipo');
    if (!desc || !desc.value.trim()) { showToast('Describe el trabajo a realizar', 'error'); return; }
    extraData.descEquipo = desc.value.trim();
  }

  const numActual = state.modoEdicion
    ? state.incidencias.indexOf(state.incidenciaActual) + 1
    : state.incidencias.length + 1;

  const incidencia = {
    num: numActual,
    codigo: generarCodigo(numActual),
    descripcion,
    tipo,
    fotos: [...state.fotos],
    timestamp: new Date().toISOString(),
    ...extraData
  };

  if (state.modoEdicion && state.incidenciaActual) {
    const idx = state.incidencias.indexOf(state.incidenciaActual);
    if (idx !== -1) state.incidencias[idx] = incidencia;
  } else {
    state.incidencias.push(incidencia);
  }

  state.fotos = [];
  state.fotosCroquis = [];
  showToast('✓ Incidencia guardada correctamente', 'success');

  // Subir mini-PDF de la incidencia a Box en background
  subirPDFIncidencia(incidencia);

  if (state.modoEdicion) {
    renderResumen();
    goTo('screen-resumen');
  } else {
    // Preparar nueva incidencia
    const nextNum = state.incidencias.length + 1;
    if (nextNum > 50) {
      finalizarIncidencias();
    } else {
      iniciarNuevaIncidencia();
    }
  }
}

function finalizarIncidencias() {
  if (state.incidencias.length === 0) {
    showToast('Debes registrar al menos una incidencia', 'error');
    return;
  }
  renderResumen();
  goTo('screen-resumen');
}

function confirmGoBack() {
  if (state.incidencias.length > 0) {
    finalizarIncidencias();
  } else {
    goTo('screen-datos');
  }
}

// ======== FOTOS ========
function triggerCamera() { document.getElementById('camera-input').click(); }
function triggerGaleria() { document.getElementById('gallery-input').click(); }
function triggerCameraC() { document.getElementById('camera-input-c').click(); }
function triggerGaleriaC() { document.getElementById('gallery-input-c').click(); }

function handleFotos(input) {
  const files = Array.from(input.files);
  const disponible = 15 - state.fotos.length;
  if (disponible <= 0) { showToast('Máximo 15 fotografías por incidencia', 'error'); return; }
  const toAdd = files.slice(0, disponible);
  if (files.length > disponible) showToast(`Solo se añadirán ${disponible} foto(s) (límite 15)`, 'error');
  toAdd.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => { state.fotos.push(e.target.result); renderFotos(); };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function handleFotosCroquis(input) {
  const files = Array.from(input.files);
  const disponible = 15 - state.fotosCroquis.length;
  if (disponible <= 0) { showToast('Máximo 15 fotografías de croquis', 'error'); return; }
  const toAdd = files.slice(0, disponible);
  toAdd.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => { state.fotosCroquis.push(e.target.result); renderFotosCroquis(); };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function renderFotos() {
  const grid = document.getElementById('fotos-preview');
  const count = document.getElementById('foto-count');
  if (!grid) return;
  count.textContent = `${state.fotos.length}/15`;
  grid.innerHTML = state.fotos.map((src, i) => `
    <div class="foto-thumb">
      <img src="${src}" alt="Foto ${i+1}">
      <button class="foto-remove" onclick="removePhoto(${i})">×</button>
    </div>`).join('');
}

function renderFotosCroquis() {
  const grid = document.getElementById('croquis-preview');
  const count = document.getElementById('croquis-count');
  if (!grid) return;
  count.textContent = `${state.fotosCroquis.length}/15`;
  grid.innerHTML = state.fotosCroquis.map((src, i) => `
    <div class="foto-thumb">
      <img src="${src}" alt="Croquis ${i+1}">
      <button class="foto-remove" onclick="removeCroquis(${i})">×</button>
    </div>`).join('');
}

function removePhoto(i) {
  state.fotos.splice(i, 1);
  renderFotos();
}

function removeCroquis(i) {
  state.fotosCroquis.splice(i, 1);
  renderFotosCroquis();
}

// ======== AUDIO SPEECH ========
function toggleAudio(targetId, btnId) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('Tu navegador no soporta reconocimiento de voz', 'error');
    return;
  }
  const btn = document.getElementById(btnId);
  if (state.recognition) {
    state.recognition.stop();
    state.recognition = null;
    if (btn) { btn.classList.remove('recording'); btn.querySelector('span').textContent = btn.dataset.origText || 'Dictar'; }
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'es-ES';
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.onresult = e => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
    const el = document.getElementById(targetId);
    if (el) el.value = (el.value ? el.value + ' ' : '') + transcript;
  };
  recognition.onerror = () => {
    state.recognition = null;
    if (btn) { btn.classList.remove('recording'); btn.querySelector('span').textContent = btn.dataset.origText; }
  };
  recognition.onend = () => {
    state.recognition = null;
    if (btn) { btn.classList.remove('recording'); btn.querySelector('span').textContent = btn.dataset.origText; }
  };
  if (btn) {
    btn.dataset.origText = btn.querySelector('span').textContent;
    btn.classList.add('recording');
    btn.querySelector('span').textContent = '● Grabando... (toca para detener)';
  }
  state.recognition = recognition;
  recognition.start();
}

// ======== RESUMEN ========
function renderResumen() {
  const list = document.getElementById('resumen-list');
  document.getElementById('stat-total').textContent = state.incidencias.length;
  document.getElementById('stat-material').textContent = state.incidencias.filter(i => i.tipo === 'material').length;
  document.getElementById('stat-equipo').textContent = state.incidencias.filter(i => i.tipo === 'equipo').length;

  list.innerHTML = state.incidencias.map((inc, i) => {
    const tipoTag = inc.tipo === 'material'
      ? '<span class="tag tag-material">CON MATERIAL</span>'
      : inc.tipo === 'documentacion'
      ? '<span class="tag tag-doc">DOCUMENTACIÓN</span>'
      : '<span class="tag tag-equipo">SIN MATERIAL</span>';
    return `
      <div class="resumen-card" onclick="editarIncidencia(${i})">
        <div class="resumen-card-code">${inc.codigo}</div>
        <div class="resumen-card-body">
          <div class="resumen-card-desc">${inc.descripcion}</div>
          <div class="resumen-card-meta">
            ${tipoTag}
            <span>${inc.fotos ? inc.fotos.length : 0} foto(s)</span>
          </div>
        </div>
        <div class="edit-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </div>
      </div>`;
  }).join('');
}

function editarIncidencia(i) {
  state.incidenciaIndex = i;
  iniciarNuevaIncidencia(state.incidencias[i]);
}

// ======== MODAL ========
function closeModal() {
  document.getElementById('modal-edit').style.display = 'none';
}

function saveModalEdit() {
  closeModal();
}

// ======== PDF GENERATION ========
async function generarPDF() {
  showLoading('Generando informe PDF...');
  try {
    // Cargar jsPDF dinámicamente
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const W = 210, H = 297;
    const margin = 14;
    const colW = W - 2 * margin;
    let y = 0;

    const datos = state.datosInstalacion;
    const fecha = datos.fecha ? new Date(datos.fecha + 'T00:00:00').toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) : '';

    // ---- PORTADA ----
    // Fondo oscuro
    doc.setFillColor(10, 22, 40);
    doc.rect(0, 0, W, H, 'F');
    // Franja superior azul
    doc.setFillColor(0, 107, 151);
    doc.rect(0, 0, W, 28, 'F');
    // Logo ROURA CEVASA
    try { doc.addImage(LOGO_B64, 'JPEG', margin, 3, 22, 22); } catch(e) {}
    // Texto cabecera portada
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(255, 255, 255);
    doc.text('ROURA CEVASA', margin + 26, 13);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(180, 220, 240);
    doc.text('GESTIÓN DE INSTALACIONES', margin + 26, 21);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('CERTIFICADO FINAL DE OBRA', W - margin, 16, { align: 'right' });

    y = 50;
    doc.setDrawColor(0, 107, 151);
    doc.line(margin, y, W - margin, y);
    y += 10;
    doc.setTextColor(232, 240, 255);
    doc.setFontSize(28);
    doc.text('INFORME DE INCIDENCIAS', margin, y);
    y += 12;
    doc.setFontSize(13);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(140, 160, 190);
    doc.text('VISITA CFO · DOCUMENTACIÓN TÉCNICA', margin, y);

    y = 130;
    // Tabla datos instalación
    const datosRows = [
      ['Nº Pedido', datos.numPedido],
      ['Punto de Abanderamiento', datos.puntoAbanderamiento],
      ['Fecha de Visita', fecha],
      ['Ubicación', datos.ubicacion],
    ];
    datosRows.forEach(([label, val], i) => {
      doc.setFillColor(22, 32, 53);
      doc.rect(margin, y, colW, 12, 'F');
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 107, 151);
      doc.text(label.toUpperCase(), margin + 4, y + 7.5);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(220, 235, 255);
      const valText = val || '—';
      doc.text(valText.length > 50 ? valText.substring(0, 50) + '...' : valText, margin + 4 + 52, y + 7.5);
      y += 14;
    });

    y += 8;
    doc.setFillColor(22, 32, 53);
    doc.rect(margin, y, colW, 12, 'F');
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 107, 151);
    doc.text('INGENIERO RESPONSABLE', margin + 4, y + 7.5);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(220, 235, 255);
    doc.text(datos.nombreIngeniero || '—', margin + 4 + 52, y + 7.5);
    y += 14;
    doc.setFillColor(22, 32, 53);
    doc.rect(margin, y, colW, 12, 'F');
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 107, 151);
    doc.text('TELÉFONO', margin + 4, y + 7.5);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(220, 235, 255);
    doc.text(datos.telIngeniero || '—', margin + 4 + 52, y + 7.5);
    y += 14;
    doc.setFillColor(22, 32, 53);
    doc.rect(margin, y, colW, 12, 'F');
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 107, 151);
    doc.text('EMAIL', margin + 4, y + 7.5);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(220, 235, 255);
    doc.text(datos.emailIngeniero || '—', margin + 4 + 52, y + 7.5);

    // Resumen incidencias en portada
    y = H - 55;
    doc.setFillColor(0, 107, 151);
    doc.rect(margin, y, colW, 0.5, 'F');
    y += 8;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 107, 151);
    doc.text(`TOTAL INCIDENCIAS REGISTRADAS: ${state.incidencias.length}`, margin, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(140, 160, 190);
    doc.setFontSize(8);
    doc.text(`Con material: ${state.incidencias.filter(i => i.tipo === 'material').length}   ·   Documentación: ${state.incidencias.filter(i => i.tipo === 'documentacion').length}   ·   Sin material: ${state.incidencias.filter(i => i.tipo === 'equipo').length}`, margin, y);

    // Pie portada
    y = H - 12;
    doc.setFontSize(7);
    doc.setTextColor(60, 80, 110);
    doc.text(`Documento generado por ROURA CEVASA CFO App · ${new Date().toLocaleDateString('es-ES')}`, W / 2, y, { align: 'center' });

    // ---- PÁGINAS DE INCIDENCIAS ----
    for (let idx = 0; idx < state.incidencias.length; idx++) {
      const inc = state.incidencias[idx];
      doc.addPage();

      // Cabecera página
      doc.setFillColor(10, 22, 40);
      doc.rect(0, 0, W, H, 'F');
      doc.setFillColor(0, 107, 151);
      doc.rect(0, 0, W, 14, 'F');
      try { doc.addImage(LOGO_B64, 'JPEG', margin, 2, 10, 10); } catch(e) {}
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('ROURA CEVASA · INFORME CFO', margin + 13, 9);
      doc.text(`Pág. ${idx + 2}`, W - margin, 9, { align: 'right' });

      y = 22;
      // Banda código incidencia
      doc.setFillColor(22, 32, 53);
      doc.rect(margin, y, colW, 14, 'F');
      doc.setFillColor(0, 107, 151);
      doc.rect(margin, y, 3, 14, 'F');
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(140, 160, 190);
      doc.text('CÓDIGO DE INCIDENCIA', margin + 7, y + 5);
      doc.setFontSize(11);
      doc.setTextColor(0, 107, 151);
      doc.text(inc.codigo, margin + 7, y + 12);
      // Tipo tag
      const tipoTexto = inc.tipo === 'material' ? 'NECESITA MATERIAL' : inc.tipo === 'documentacion' ? 'MODIFICAR DOCUMENTACIÓN' : 'EQUIPO SIN MATERIAL';
      const tipoColor = inc.tipo === 'material' ? [200, 60, 60] : inc.tipo === 'documentacion' ? [60, 100, 200] : [32, 180, 100];
      doc.setFillColor(...tipoColor);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      const tipoW = doc.getTextWidth(tipoTexto) + 10;
      doc.roundedRect(W - margin - tipoW, y + 5, tipoW, 7, 1.5, 1.5, 'F');
      doc.text(tipoTexto, W - margin - tipoW / 2, y + 10, { align: 'center' });

      y += 20;

      // DESCRIPCIÓN
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 107, 151);
      doc.text('01 · DESCRIPCIÓN DE LA INCIDENCIA', margin, y);
      doc.setDrawColor(0, 107, 151);
      doc.line(margin, y + 2, W - margin, y + 2);
      y += 7;
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(220, 235, 255);
      const descLines = doc.splitTextToSize(inc.descripcion || '—', colW);
      doc.text(descLines, margin, y);
      y += descLines.length * 5 + 6;

      // TIPO DETALLE
      if (inc.tipo === 'material' && inc.infoMaterial) {
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 107, 151);
        doc.text('05 · INFORMACIÓN DEL MATERIAL NECESARIO', margin, y);
        doc.setDrawColor(0, 107, 151);
        doc.line(margin, y + 2, W - margin, y + 2);
        y += 7;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(220, 235, 255);
        const matLines = doc.splitTextToSize(inc.infoMaterial, colW);
        doc.text(matLines, margin, y);
        y += matLines.length * 5 + 8;
      } else if (inc.tipo === 'documentacion' && inc.descDocumentacion) {
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 107, 151);
        doc.text('04 · MODIFICACIÓN DE DOCUMENTACIÓN', margin, y);
        doc.setDrawColor(0, 107, 151);
        doc.line(margin, y + 2, W - margin, y + 2);
        y += 7;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(220, 235, 255);
        const docLines = doc.splitTextToSize(inc.descDocumentacion, colW);
        doc.text(docLines, margin, y);
        y += docLines.length * 5 + 8;
      } else if (inc.tipo === 'equipo' && inc.descEquipo) {
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 107, 151);
        doc.text('04 · TRABAJO A REALIZAR POR EQUIPO', margin, y);
        doc.setDrawColor(0, 107, 151);
        doc.line(margin, y + 2, W - margin, y + 2);
        y += 7;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(220, 235, 255);
        const eqLines = doc.splitTextToSize(inc.descEquipo, colW);
        doc.text(eqLines, margin, y);
        y += eqLines.length * 5 + 8;
      }

      // FOTOGRAFÍAS INCIDENCIA
      if (inc.fotos && inc.fotos.length > 0) {
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 107, 151);
        doc.text(`02 · FOTOGRAFÍAS DE LA INCIDENCIA (${inc.fotos.length})`, margin, y);
        doc.setDrawColor(0, 107, 151);
        doc.line(margin, y + 2, W - margin, y + 2);
        y += 7;
        y = await addPhotosGrid(doc, inc.fotos, y, margin, colW, W, H);
        y += 6;
      }

      // FOTOGRAFÍAS CROQUIS
      if (inc.fotosCroquis && inc.fotosCroquis.length > 0) {
        if (y > H - 80) { doc.addPage(); y = 22; addPageHeader(doc, W, margin, idx + 3, datos); }
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 107, 151);
        doc.text(`04 · FOTOGRAFÍAS CROQUIS MATERIAL (${inc.fotosCroquis.length})`, margin, y);
        doc.setDrawColor(0, 107, 151);
        doc.line(margin, y + 2, W - margin, y + 2);
        y += 7;
        y = await addPhotosGrid(doc, inc.fotosCroquis, y, margin, colW, W, H);
      }

      // Pie página
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(50, 70, 100);
      doc.text(`${datos.numPedido} · ${datos.nombreIngeniero} · ${fecha}`, W / 2, H - 8, { align: 'center' });
    }

    // Guardar localmente
    const filename = `${state.numPedido} Informe Final CFO.pdf`;
    doc.save(filename);

    // ── EXPORTAR JSON de datos para cierre posterior ──
    exportarDatosJSON();

    hideLoading();
    showToast('✓ PDF e informe .json descargados. Sincronizando con Dropbox...', 'success');

    // Subir PDF final a Box en segundo plano
    subirPDFFinalACloudinary(doc).then(url => {
      if (url) {
        state.cloudInformeUrl = url;
        showToast('📁 Informe guardado en Dropbox', 'success');
      }
      // Mostrar botones finales
      const btnVolver = document.getElementById('btn-volver-inicio');
      const btnPDF    = document.getElementById('btn-generar-pdf');
      const btnEmail  = document.getElementById('btn-enviar-email');
      if (btnVolver) btnVolver.style.display = 'flex';
      if (btnPDF)    btnPDF.style.display = 'none';
      if (btnEmail)  btnEmail.style.display = 'flex';
    }).catch(() => {
      const btnVolver = document.getElementById('btn-volver-inicio');
      const btnPDF    = document.getElementById('btn-generar-pdf');
      const btnEmail  = document.getElementById('btn-enviar-email');
      if (btnVolver) btnVolver.style.display = 'flex';
      if (btnPDF)    btnPDF.style.display = 'none';
      if (btnEmail)  btnEmail.style.display = 'flex';
    });

  } catch (err) {
    hideLoading();
    console.error(err);
    showToast('Error al generar el PDF: ' + err.message, 'error');
  }
}

async function addPhotosGrid(doc, fotos, startY, margin, colW, W, H) {
  const gap = 4;
  const cols = 2;
  const imgW = (colW - gap) / cols;
  const imgH = imgW * 0.75; // 4:3
  let y = startY;
  let col = 0;

  for (let i = 0; i < fotos.length; i++) {
    const x = margin + col * (imgW + gap);
    if (y + imgH > H - 20) {
      doc.addPage();
      // rebg
      doc.setFillColor(10, 22, 40);
      doc.rect(0, 0, W, H, 'F');
      doc.setFillColor(0, 107, 151);
      doc.rect(0, 0, W, 14, 'F');
      try { doc.addImage(LOGO_B64, 'JPEG', 14, 2, 10, 10); } catch(e) {}
      doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
      doc.text('ROURA CEVASA · INFORME CFO', 28, 9);
      y = 22; col = 0;
    }
    try {
      const format = detectImgFormat(fotos[i]);
      doc.addImage(fotos[i], format, x, y, imgW, imgH, undefined, 'FAST');
      // Borde foto
      doc.setDrawColor(37, 52, 80);
      doc.rect(x, y, imgW, imgH);
      // Número foto
      doc.setFillColor(0, 0, 0, 0.5);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text(`${i + 1}`, x + 2.5, y + 5.5);
    } catch(e) { /* skip bad image */ }
    col++;
    if (col >= cols) { col = 0; y += imgH + gap; }
  }
  if (col > 0) y += imgH + gap;
  return y;
}

function detectImgFormat(dataUrl) {
  if (dataUrl.startsWith('data:image/png')) return 'PNG';
  if (dataUrl.startsWith('data:image/webp')) return 'WEBP';
  return 'JPEG';
}

function addPageHeader(doc, W, margin, pageNum, datos) {
  doc.setFillColor(0, 107, 151);
  doc.rect(0, 0, W, 14, 'F');
  try { doc.addImage(LOGO_B64, 'JPEG', margin, 2, 10, 10); } catch(e) {}
  doc.setFontSize(8);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(255, 255, 255);
  doc.text('ROURA CEVASA · INFORME CFO', margin + 13, 9);
  doc.text(`Pág. ${pageNum}`, W - margin, 9, { align: 'right' });
}

// ======== UTILS ========
function volverAlInicio() {
  // Reset completo del estado
  state = {
    datosInstalacion: {}, incidencias: [], incidenciaActual: null,
    numPedido: '', incidenciaIndex: 0, modoEdicion: false,
    recognition: null, audioTarget: null, fotos: [], fotosCroquis: []
  };
  // Resetear formulario datos
  ['num-pedido','punto-abanderamiento','ubicacion','nombre-ingeniero','tel-ingeniero','email-ingeniero'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = '';
  });
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const dateEl = document.getElementById('fecha-visita');
  if(dateEl) dateEl.value = `${yyyy}-${mm}-${dd}`;
  // Ocultar botón volver, mostrar generar PDF
  const btnVolver = document.getElementById('btn-volver-inicio');
  const btnPDF = document.getElementById('btn-generar-pdf');
  if(btnVolver) btnVolver.style.display = 'none';
  if(btnPDF) btnPDF.style.display = 'flex';
  goTo('screen-main');
}

function loadScript(src) {
  return new Promise((res, rej) => {
    if (document.querySelector(`script[src="${src}"]`)) { res(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });
}

function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type}`;
  void t.offsetWidth;
  t.classList.add('show');
  clearTimeout(t._timeout);
  t._timeout = setTimeout(() => t.classList.remove('show'), 3200);
}

function showLoading(msg = 'Procesando...') {
  document.getElementById('loading-text').textContent = msg;
  document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

// ╔══════════════════════════════════════════════════════════════╗
// ║         CONFIGURACIÓN — DROPBOX OAuth 2.0 PKCE              ║
// ╚══════════════════════════════════════════════════════════════╝

// Dropbox API v2 — OAuth 2.0 con PKCE (sin secreto en cliente)
const DBX_AUTH_URL  = 'https://www.dropbox.com/oauth2/authorize';
const DBX_TOKEN_URL = 'https://api.dropboxapi.com/oauth2/token';
const DBX_API       = 'https://api.dropboxapi.com/2';
const DBX_CONTENT   = 'https://content.dropboxapi.com/2';

let cfg = { googleClientId: '', emailDest: '' }; // googleClientId = Dropbox App Key

let dbxToken    = null;  // { access_token, refresh_token, expires_at }
let dbxUser     = null;  // { name, email, account_id }
let dbxFolder   = null;  // Ruta absoluta en Dropbox, p.ej. /ROURA_CFO/PEDIDO_20240101

// ── Helpers PKCE ──
async function pkceChallenge() {
  const array    = new Uint8Array(32);
  crypto.getRandomValues(array);
  const verifier = btoa(String.fromCharCode(...array))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const data      = new TextEncoder().encode(verifier);
  const hash      = await crypto.subtle.digest('SHA-256', data);
  const challenge = btoa(String.fromCharCode(...new Uint8Array(hash)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return { verifier, challenge };
}

// ── Persistencia ──
function loadConfig() {
  try {
    const saved = localStorage.getItem('roura_cfo_config_v5');
    if (saved) cfg = { ...cfg, ...JSON.parse(saved) };
    const savedToken = sessionStorage.getItem('roura_dbx_token');
    if (savedToken) {
      const t = JSON.parse(savedToken);
      if (!t.expires_at || t.expires_at > Date.now()) dbxToken = t;
    }
    const savedUser = sessionStorage.getItem('roura_dbx_user');
    if (savedUser) dbxUser = JSON.parse(savedUser);
    const savedFolder = sessionStorage.getItem('roura_dbx_folder');
    if (savedFolder) dbxFolder = savedFolder;
  } catch(e) {}
  const clientEl = document.getElementById('cfg-google-client-id');
  if (clientEl && cfg.googleClientId) clientEl.value = cfg.googleClientId;
  const destEl = document.getElementById('cfg-email-dest');
  if (destEl && cfg.emailDest) destEl.value = cfg.emailDest;
  // Manejar callback OAuth de Dropbox (código en URL)
  handleDropboxCallback();
  updateConfigStatus();
}

function saveConfig() {
  cfg.googleClientId = (document.getElementById('cfg-google-client-id')?.value || '').trim();
  cfg.emailDest      = (document.getElementById('cfg-email-dest')?.value || '').trim();
  try { localStorage.setItem('roura_cfo_config_v5', JSON.stringify(cfg)); } catch(e) {}
  updateConfigStatus();
}

function guardarConfig() {
  saveConfig();
  showToast('✓ Configuración guardada', 'success');
  goTo('screen-main');
}

function updateConfigStatus() {
  const ok       = !!(dbxToken && dbxUser);
  const folderOk = !!dbxFolder;
  const dotG  = document.getElementById('dot-google');
  const lblG  = document.getElementById('lbl-google');
  const dotD  = document.getElementById('dot-drive');
  const lblD  = document.getElementById('lbl-drive');
  if (dotG) dotG.className = `status-dot ${ok ? 'ok' : (cfg.googleClientId ? 'warn' : 'off')}`;
  if (lblG) lblG.textContent = dbxUser
    ? (dbxUser.email || dbxUser.name || '—')
    : (cfg.googleClientId ? 'App Key configurado' : 'No configurado');
  if (dotD) dotD.className  = `status-dot ${folderOk ? 'ok' : 'off'}`;
  if (lblD) lblD.textContent = folderOk ? dbxFolder.split('/').pop() : '—';
  const card    = document.getElementById('google-user-card');
  const btn     = document.getElementById('btn-google-signin');
  if (card && btn) {
    if (dbxUser || dbxToken) {
      card.style.display = 'flex'; btn.style.display = 'none';
      const nameEl   = document.getElementById('google-user-name');
      const emailEl  = document.getElementById('google-user-email');
      const avatarEl = document.getElementById('google-avatar');
      if (nameEl)   nameEl.textContent   = dbxUser?.name  || 'Usuario Dropbox';
      if (emailEl)  emailEl.textContent  = dbxUser?.email || '—';
      if (avatarEl) avatarEl.textContent = (dbxUser?.name || 'D')[0].toUpperCase();
    } else {
      card.style.display = 'none'; btn.style.display = 'flex';
    }
  }
}

// ╔══════════════════════════════════════════════════════════════╗
// ║          DROPBOX — OAUTH 2.0 PKCE — SIGN IN / OUT           ║
// ╚══════════════════════════════════════════════════════════════╝

async function googleSignIn() {   // mantiene nombre para no romper HTML
  const appKey = (document.getElementById('cfg-google-client-id')?.value || cfg.googleClientId || '').trim();
  if (!appKey) { showToast('Introduce primero el Dropbox App Key', 'error'); return; }
  cfg.googleClientId = appKey;
  saveConfig();

  const { verifier, challenge } = await pkceChallenge();
  try { sessionStorage.setItem('roura_pkce_verifier', verifier); } catch(e) {}

  const redirectUri = window.location.href.split('?')[0].split('#')[0];
  const params = new URLSearchParams({
    client_id:             appKey,
    response_type:         'code',
    redirect_uri:          redirectUri,
    code_challenge:        challenge,
    code_challenge_method: 'S256',
    token_access_type:     'offline',  // para obtener refresh_token
    state:                 'dbx_auth',
  });
  window.location.href = `${DBX_AUTH_URL}?${params.toString()}`;
}

async function handleDropboxCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const code      = urlParams.get('code');
  const state     = urlParams.get('state');
  if (!code || state !== 'dbx_auth') return;

  // Limpiar URL sin recargar
  window.history.replaceState({}, '', window.location.pathname);

  const verifier   = sessionStorage.getItem('roura_pkce_verifier') || '';
  const appKey     = cfg.googleClientId;
  const redirectUri = window.location.href.split('?')[0].split('#')[0];

  showLoading('Conectando con Dropbox...');
  try {
    const resp = await fetch(DBX_TOKEN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        code,
        grant_type:    'authorization_code',
        client_id:     appKey,
        redirect_uri:  redirectUri,
        code_verifier: verifier,
      }),
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error_description || `HTTP ${resp.status}`);
    }
    const data = await resp.json();
    dbxToken = {
      access_token:  data.access_token,
      refresh_token: data.refresh_token || null,
      expires_at:    data.expires_in ? Date.now() + (data.expires_in - 60) * 1000 : null,
    };
    try { sessionStorage.setItem('roura_dbx_token', JSON.stringify(dbxToken)); } catch(e) {}

    // Obtener perfil
    const profileResp = await fetch(`${DBX_API}/users/get_current_account`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${dbxToken.access_token}`,
        'Content-Type':  'application/json',
      },
      body: 'null',
    });
    if (profileResp.ok) {
      const profile = await profileResp.json();
      dbxUser = {
        name:       profile.name?.display_name || '—',
        email:      profile.email || '—',
        account_id: profile.account_id,
      };
      try { sessionStorage.setItem('roura_dbx_user', JSON.stringify(dbxUser)); } catch(e) {}
    }
    hideLoading();
    updateConfigStatus();
    goTo('screen-config');
    showToast(`✅ Dropbox conectado: ${dbxUser?.email || dbxUser?.name || 'usuario'}`, 'success');

    // Al conectar Dropbox, sincronizar usuarios inmediatamente
    // Si hay usuarios en Dropbox → cargarlos; si no → subirlos
    setTimeout(async () => {
      try {
        const remoteUsers = await dbxDownloadUsers();
        if (remoteUsers && remoteUsers.length > 0) {
          // Dropbox tiene datos → fusionar (Dropbox gana en conflictos)
          await window.storage.set(USERS_KEY, JSON.stringify(remoteUsers));
          showToast(`📁 ${remoteUsers.length} usuarios cargados desde Dropbox`, 'success');
        } else {
          // Primera vez → subir usuarios locales
          const localUsers = await loadUsers();
          await dbxSyncUsersToDropbox(localUsers);
          showToast('📁 Usuarios guardados en Dropbox por primera vez', 'success');
        }
      } catch(e) {
        console.warn('Sync inicial usuarios Dropbox:', e.message);
      }
    }, 1000);

  } catch(e) {
    hideLoading();
    showToast('❌ Error Dropbox OAuth: ' + e.message, 'error');
  }
}

async function refreshDropboxToken() {
  if (!dbxToken?.refresh_token || !cfg.googleClientId) return false;
  try {
    const resp = await fetch(DBX_TOKEN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type:    'refresh_token',
        refresh_token: dbxToken.refresh_token,
        client_id:     cfg.googleClientId,
      }),
    });
    if (!resp.ok) return false;
    const data = await resp.json();
    dbxToken = {
      ...dbxToken,
      access_token: data.access_token,
      expires_at:   data.expires_in ? Date.now() + (data.expires_in - 60) * 1000 : null,
    };
    try { sessionStorage.setItem('roura_dbx_token', JSON.stringify(dbxToken)); } catch(e) {}
    return true;
  } catch(e) { return false; }
}

function googleSignOut() {   // mantiene nombre
  dbxToken  = null;
  dbxUser   = null;
  dbxFolder = null;
  try {
    sessionStorage.removeItem('roura_dbx_token');
    sessionStorage.removeItem('roura_dbx_user');
    sessionStorage.removeItem('roura_dbx_folder');
    sessionStorage.removeItem('roura_pkce_verifier');
  } catch(e) {}
  updateConfigStatus();
  showToast('Sesión Dropbox cerrada', '');
}

async function ensureValidToken() {   // mantiene nombre
  if (dbxToken) {
    if (!dbxToken.expires_at || dbxToken.expires_at > Date.now()) return dbxToken.access_token;
    const ok = await refreshDropboxToken();
    if (ok) return dbxToken.access_token;
  }
  throw new Error('Sesión Dropbox expirada. Vuelve a conectar en Configuración.');
}

// ╔══════════════════════════════════════════════════════════════╗
// ║                  DROPBOX — API v2                           ║
// ╚══════════════════════════════════════════════════════════════╝

function driveFolderName() {
  if (!state.numPedido) return 'SIN_PEDIDO_ROURA_CFO';
  const pedido = state.numPedido.replace(/[^A-Z0-9\-_]/gi,'').toUpperCase();
  const fecha  = (state.datosInstalacion.fecha || '').replace(/-/g,'');
  // Nombre SIEMPRE empieza por el número de pedido
  return `${pedido}_CFO_${fecha}`;
}

function cloudFolder() { return driveFolderName(); }

// ── SISTEMA DE USUARIOS EN DROPBOX ──────────────────────────────────
// Toda la gestión de usuarios se persiste en la misma cuenta Dropbox
// que los documentos CFO, en una carpeta especial de sistema.
const DBX_SISTEMA_DIR  = '/ROURA_CFO/_SISTEMA_USUARIOS';
const DBX_USERS_FILE   = `${DBX_SISTEMA_DIR}/usuarios.json`;
const DBX_ACCESOS_FILE = `${DBX_SISTEMA_DIR}/registro_accesos.json`;

/**
 * Crea una carpeta en Dropbox (idempotente — ignora si ya existe).
 */
async function dbxCreateFolder(path) {
  const token = await ensureValidToken();
  const resp  = await fetch(`${DBX_API}/files/create_folder_v2`, {
    method:  'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type':  'application/json',
    },
    body: JSON.stringify({ path, autorename: false }),
  });
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    // path/conflict/folder = ya existe → OK
    if (err?.error?.['.tag'] === 'path' &&
        err?.error?.path?.['.tag'] === 'conflict') return path;
    if (resp.status !== 409) throw new Error(err?.error_summary || `HTTP ${resp.status}`);
  }
  return path;
}

/**
 * Sube un Blob a Dropbox con upload_session para compatibilidad con archivos grandes.
 * Para PDFs pequeños (<150 MB) usa upload simple.
 */
async function dbxUploadBlob(blob, dropboxPath) {
  const token    = await ensureValidToken();
  const safePath = dropboxPath.replace(/[\\:*?"<>|]/g,'_');

  const resp = await fetch(`${DBX_CONTENT}/files/upload`, {
    method:  'POST',
    headers: {
      'Authorization':   `Bearer ${token}`,
      'Content-Type':    'application/octet-stream',
      'Dropbox-API-Arg': JSON.stringify({
        path:       safePath,
        mode:       'overwrite',
        autorename: false,
        mute:       true,
      }),
    },
    body: blob,
  });
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err?.error_summary || `HTTP ${resp.status}`);
  }
  const data = await resp.json();
  return {
    path:   data.path_display || safePath,
    name:   data.name || safePath.split('/').pop(),
    id:     data.id,
    webUrl: `https://www.dropbox.com/home${encodeURIComponent(data.path_display || safePath)}`,
  };
}

/**
 * Crea la carpeta raíz de la visita en Dropbox.
 */
async function crearCarpetaCloudinary() {   // mantiene nombre para no romper HTML
  if (!dbxToken) return;
  try {
    // Raíz compartida de la app
    const rootPath = '/ROURA_CFO';
    // Carpeta del pedido — SIEMPRE empieza por el nº de pedido
    const subPath  = `${rootPath}/${driveFolderName()}`;
    await dbxCreateFolder(rootPath);
    await dbxCreateFolder(subPath);
    dbxFolder = subPath;
    try { sessionStorage.setItem('roura_dbx_folder', subPath); } catch(e) {}

    // Metadatos del pedido
    const meta = JSON.stringify({
      pedido:    state.datosInstalacion.numPedido,
      punto:     state.datosInstalacion.puntoAbanderamiento,
      fecha:     state.datosInstalacion.fecha,
      ingeniero: state.datosInstalacion.nombreIngeniero,
      creadoEn:  new Date().toISOString(),
    }, null, 2);
    await dbxUploadBlob(
      new Blob([meta], { type: 'application/json' }),
      `${subPath}/00_INFO_PEDIDO.json`
    );

    // Asegurar que la carpeta de sistema de usuarios también existe
    await dbxCreateFolderSilent(DBX_SISTEMA_DIR);

    updateConfigStatus();
    showToast(`📁 Dropbox: ${subPath}`, 'success');
  } catch(e) {
    console.warn('crearCarpetaCloudinary (Dropbox):', e.message);
  }
}

/**
 * Genera y sube el mini-PDF de una incidencia individual.
 */
async function subirPDFIncidencia(incidencia) {
  if (!dbxToken || !dbxFolder) return;
  try {
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    const { jsPDF } = window.jspdf;
    const doc  = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
    const W=210, H=297, margin=14, colW=182;
    const datos = state.datosInstalacion;

    doc.setFillColor(10,22,40); doc.rect(0,0,W,H,'F');
    doc.setFillColor(0,107,151); doc.rect(0,0,W,14,'F');
    try { doc.addImage(LOGO_B64,'JPEG',margin,2,10,10); } catch(e) {}
    doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
    doc.text('ROURA CEVASA · INCIDENCIA', margin+13, 9);
    doc.text('Pág. 1', W-margin, 9, {align:'right'});
    let y = 22;

    doc.setFillColor(22,32,53); doc.rect(margin,y,colW,14,'F');
    doc.setFillColor(0,107,151); doc.rect(margin,y,3,14,'F');
    doc.setFontSize(7); doc.setFont('helvetica','bold'); doc.setTextColor(140,160,190);
    doc.text('CÓDIGO', margin+7, y+5);
    doc.setFontSize(11); doc.setTextColor(0,107,151);
    doc.text(incidencia.codigo, margin+7, y+12);
    const tipoTexto = incidencia.tipo==='material'?'NECESITA MATERIAL':incidencia.tipo==='documentacion'?'MODIFICAR DOC.':'EQUIPO SIN MATERIAL';
    const tipoColor = incidencia.tipo==='material'?[200,60,60]:incidencia.tipo==='documentacion'?[60,100,200]:[32,180,100];
    doc.setFillColor(...tipoColor); doc.setFontSize(7); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
    const tipoW = doc.getTextWidth(tipoTexto)+10;
    doc.roundedRect(W-margin-tipoW,y+5,tipoW,7,1.5,1.5,'F');
    doc.text(tipoTexto, W-margin-tipoW/2, y+10, {align:'center'});
    y += 20;

    doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(140,160,190);
    doc.text(`Pedido: ${datos.numPedido}  ·  ${datos.puntoAbanderamiento}  ·  ${datos.fecha}  ·  ${datos.nombreIngeniero}`, margin, y);
    y += 8;
    doc.setFontSize(7); doc.setFont('helvetica','bold'); doc.setTextColor(0,107,151);
    doc.text('DESCRIPCIÓN', margin, y);
    doc.setDrawColor(0,107,151); doc.line(margin,y+2,W-margin,y+2); y += 7;
    doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(220,235,255);
    const descLines = doc.splitTextToSize(incidencia.descripcion||'—', colW);
    doc.text(descLines, margin, y); y += descLines.length*5+8;

    const extra = incidencia.infoMaterial||incidencia.descDocumentacion||incidencia.descEquipo;
    if (extra) {
      const lbl = incidencia.infoMaterial?'MATERIAL NECESARIO':incidencia.descDocumentacion?'MODIFICACIÓN DOCUMENTACIÓN':'TRABAJO A REALIZAR';
      doc.setFontSize(7); doc.setFont('helvetica','bold'); doc.setTextColor(0,107,151);
      doc.text(lbl, margin, y); doc.setDrawColor(0,107,151); doc.line(margin,y+2,W-margin,y+2); y+=7;
      doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(220,235,255);
      const eLines = doc.splitTextToSize(extra, colW);
      doc.text(eLines, margin, y); y += eLines.length*5+8;
    }
    if (incidencia.fotos?.length > 0) {
      y = await addPhotosGrid(doc, incidencia.fotos.slice(0,4), y, margin, colW, W, H);
    }
    doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(50,70,100);
    doc.text(`ROURA CEVASA CFO App · ${new Date().toLocaleDateString('es-ES')}`, W/2, H-8, {align:'center'});

    const filename = `${incidencia.codigo}.pdf`;
    doc.save(filename);

    const result = await dbxUploadBlob(doc.output('blob'), `${dbxFolder}/${filename}`);
    if (result) {
      incidencia.cloudPdfUrl = result.webUrl;
      const statusEl = document.getElementById('inc-upload-status');
      if (statusEl) {
        statusEl.innerHTML = `<span class="upload-pill">📦 Dropbox</span>`;
        statusEl.style.display = 'inline';
      }
    }
  } catch(e) {
    console.warn('subirPDFIncidencia (Dropbox):', e.message);
  }
}

/**
 * Sube el PDF final del informe a Dropbox.
 */
async function subirPDFFinalACloudinary(doc) {   // mantiene nombre
  if (!dbxToken || !dbxFolder) return null;
  try {
    const numPed   = state.numPedido || cierreState?.datosInforme?.numPedido || 'INFORME';
    const filename = `${numPed} Informe Final CFO.pdf`;
    const result   = await dbxUploadBlob(doc.output('blob'), `${dbxFolder}/${filename}`);
    return result?.webUrl || null;
  } catch(e) {
    console.warn('subirPDFFinalACloudinary (Dropbox):', e.message);
    return null;
  }
}

/**
 * Sube el PDF de cierre a Dropbox.
 */
async function subirPDFCierreABox(doc, numPedido) {   // mantiene nombre
  if (!dbxToken) return null;
  try {
    // Buscar si ya existe la carpeta del pedido, si no, usar raíz
    const pedidoClean = (numPedido || 'SIN-PEDIDO').replace(/[^A-Z0-9\-_]/gi,'').toUpperCase();
    const fecha = (cierreState?.datosInforme?.datosInstalacion?.fecha || '').replace(/-/g,'');
    // Nombre de carpeta empieza por el nº de pedido
    const folderName = fecha ? `${pedidoClean}_CFO_${fecha}` : `${pedidoClean}_CFO`;
    const folder = dbxFolder || `/ROURA_CFO/${folderName}`;
    // Crear carpeta si no existe
    await dbxCreateFolderSilent('/ROURA_CFO');
    await dbxCreateFolderSilent(folder);
    const filename = `${numPedido} Informe Cierre CFO.pdf`;
    const result   = await dbxUploadBlob(doc.output('blob'), `${folder}/${filename}`);
    return result?.webUrl || null;
  } catch(e) {
    console.warn('subirPDFCierreABox (Dropbox):', e.message);
    return null;
  }
}

// ╔══════════════════════════════════════════════════════════════╗
// ║          EMAIL — ENLACE MAILTO                              ║
// ╚══════════════════════════════════════════════════════════════╝

async function enviarEmailGmail({ to, cc, subject, body }) {
  const mailtoLink = `mailto:${encodeURIComponent(to)}${cc?'?cc='+encodeURIComponent(cc)+'&':'?'}subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(mailtoLink, '_blank');
  return true;
}

// ╔══════════════════════════════════════════════════════════════╗
// ║               MODAL DE ENVÍO DE EMAIL                       ║
// ╚══════════════════════════════════════════════════════════════╝

function showEmailModal() {
  const destEl = document.getElementById('email-dest-modal');
  if (destEl) destEl.value = cfg.emailDest || state.datosInstalacion.emailIngeniero || '';
  const subjEl = document.getElementById('email-subject-modal');
  if (subjEl) {
    const d = state.datosInstalacion;
    subjEl.value = `Informe CFO — ${d.numPedido} · ${d.puntoAbanderamiento} (${d.fecha})`;
  }
  const msgEl = document.getElementById('email-msg-modal');
  if (msgEl) {
    const d = state.datosInstalacion;
    const lista = state.incidencias.map((inc,i) => {
      const tipo = inc.tipo==='material'?'Con material':inc.tipo==='documentacion'?'Documentación':'Sin material';
      return `  ${i+1}. [${inc.codigo}] (${tipo}): ${inc.descripcion.substring(0,60)}${inc.descripcion.length>60?'...':''}`;
    }).join('\n');
    msgEl.value = `Estimado/a,\n\nAdjunto informe de la visita CFO realizada el ${d.fecha} en ${d.puntoAbanderamiento}.\n\nPedido: ${d.numPedido}\nIngeniero: ${d.nombreIngeniero} · ${d.telIngeniero}\nUbicación: ${d.ubicacion}\nIncidencias: ${state.incidencias.length}\n\nRESUMEN:\n${lista||'  (sin incidencias)'}\n\nInforme en Dropbox:\n${state.cloudInformeUrl||'(generando enlace...)'}\n\nSaludos,\n${d.nombreIngeniero}\n${d.emailIngeniero}`;
  }
  const urlRow = document.getElementById('email-pdf-url-row');
  const urlTxt = document.getElementById('email-pdf-url-text');
  if (state.cloudInformeUrl && urlRow && urlTxt) {
    urlTxt.textContent = state.cloudInformeUrl;
    urlRow.style.display = 'flex';
  } else if (urlRow) { urlRow.style.display = 'none'; }
  document.getElementById('modal-email').style.display = 'flex';
}

function closeEmailModal() {
  document.getElementById('modal-email').style.display = 'none';
}

async function enviarEmail() {
  const dest    = document.getElementById('email-dest-modal')?.value?.trim();
  const cc      = document.getElementById('email-cc-modal')?.value?.trim();
  const subject = document.getElementById('email-subject-modal')?.value?.trim();
  const message = document.getElementById('email-msg-modal')?.value?.trim();
  if (!dest) { showToast('Introduce el email destinatario', 'error'); return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(dest)) { showToast('Email no válido', 'error'); return; }
  const btnText = document.getElementById('email-btn-text');
  if (btnText) btnText.textContent = 'Abriendo...';
  try {
    await enviarEmailGmail({ to:dest, cc:cc||'', subject:subject||`Informe CFO ${state.datosInstalacion.numPedido}`, body:message||'' });
    closeEmailModal();
    if (btnText) btnText.textContent = 'ENVIAR';
    showToast('✅ Cliente de correo abierto', 'success');
  } catch(e) {
    if (btnText) btnText.textContent = 'ENVIAR';
    showToast('❌ Error: ' + e.message, 'error');
  }
}

// ╔══════════════════════════════════════════════════════════════╗
// ║                  CERRAR CFO — ESTADO                        ║
// ╚══════════════════════════════════════════════════════════════╝

let cierreState = {
  datosInforme:    null,   // datos cargados del JSON
  incidencias:     [],     // incidencias del informe original
  cierres:         [],     // array paralelo: { fotos:[], comentario:'', cerrada:false }
  indiceActual:    0,      // índice de la incidencia en curso
  fotosCierre:     [],     // fotos de la incidencia en cierre (temp)
};

// ╔══════════════════════════════════════════════════════════════╗
// ║           EXPORTAR JSON AL GENERAR PDF                      ║
// ╚══════════════════════════════════════════════════════════════╝

function exportarDatosJSON() {
  try {
    const exportData = {
      _tipo:           'ROURA_CFO_DATOS_V1',
      exportadoEn:     new Date().toISOString(),
      datosInstalacion: { ...state.datosInstalacion },
      numPedido:       state.numPedido,
      incidencias:     state.incidencias.map(inc => ({
        num:              inc.num,
        codigo:           inc.codigo,
        tipo:             inc.tipo,
        descripcion:      inc.descripcion,
        infoMaterial:     inc.infoMaterial     || '',
        descDocumentacion: inc.descDocumentacion || '',
        descEquipo:       inc.descEquipo       || '',
        // Fotos en base64 para conservar en el cierre
        fotos:            inc.fotos      || [],
        fotosCroquis:     inc.fotosCroquis || [],
        cloudPdfUrl:      inc.cloudPdfUrl  || '',
      })),
    };
    const jsonStr  = JSON.stringify(exportData, null, 2);
    const blob     = new Blob([jsonStr], { type: 'application/json' });
    const url      = URL.createObjectURL(blob);
    const a        = document.createElement('a');
    a.href         = url;
    a.download     = `${state.numPedido} Datos CFO.json`;
    a.click();
    URL.revokeObjectURL(url);
  } catch(e) {
    console.warn('exportarDatosJSON error:', e.message);
  }
}

// ╔══════════════════════════════════════════════════════════════╗
// ║            CARGAR JSON → INICIAR CIERRE                     ║
// ╚══════════════════════════════════════════════════════════════╝

function switchMainTab(tab) {
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.main-tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  document.getElementById('panel-' + tab).classList.add('active');
}

function triggerCierreFile() {
  document.getElementById('cierre-file-input').value = '';
  document.getElementById('cierre-file-input').click();
}

function cargarInformeCierre(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data._tipo || data._tipo !== 'ROURA_CFO_DATOS_V1') {
        showToast('❌ Archivo no válido. Usa el .json generado por la app.', 'error');
        return;
      }
      cierreState.datosInforme = data;
      cierreState.incidencias  = data.incidencias || [];
      cierreState.cierres      = cierreState.incidencias.map(() => ({
        fotos: [], comentario: '', cerrada: false
      }));

      // Mostrar card con info del informe
      document.getElementById('cierre-load-zone').style.display   = 'none';
      document.getElementById('cierre-loaded-card').style.display = 'block';
      document.getElementById('btn-iniciar-cierre').style.display = 'flex';
      // Mostrar opción de cargar cierre JSON existente
      const divSep = document.getElementById('div-cargar-cierre-existente');
      const btnCierreJSON = document.getElementById('btn-cargar-cierre-json');
      if (divSep) divSep.style.display = 'flex';
      if (btnCierreJSON) btnCierreJSON.style.display = 'flex';

      const d = data.datosInstalacion;
      document.getElementById('cierre-pedido-label').textContent =
        `Pedido: ${data.numPedido}`;
      document.getElementById('cierre-meta-label').textContent =
        `${d.puntoAbanderamiento || '—'} · ${d.fecha || '—'} · ${d.nombreIngeniero || '—'} · ${cierreState.incidencias.length} incidencias`;
    } catch(err) {
      showToast('❌ Error leyendo el archivo JSON.', 'error');
    }
  };
  reader.readAsText(file);
}

function resetCierre() {
  cierreState = { datosInforme:null, incidencias:[], cierres:[], indiceActual:0, fotosCierre:[] };
  document.getElementById('cierre-load-zone').style.display   = 'flex';
  document.getElementById('cierre-loaded-card').style.display = 'none';
  document.getElementById('btn-iniciar-cierre').style.display = 'none';
  const divSep = document.getElementById('div-cargar-cierre-existente');
  const btnCJ  = document.getElementById('btn-cargar-cierre-json');
  if (divSep) divSep.style.display = 'none';
  if (btnCJ)  btnCJ.style.display  = 'none';
}

function iniciarCierreFlow() {
  renderCierreListado();
  goTo('screen-cierre-lista');
}

// ╔══════════════════════════════════════════════════════════════╗
// ║            LISTA DE INCIDENCIAS — CIERRE                    ║
// ╚══════════════════════════════════════════════════════════════╝

function renderCierreListado() {
  const incs   = cierreState.incidencias;
  const cierres = cierreState.cierres;
  const data   = cierreState.datosInforme;

  // Cabecera
  document.getElementById('cierre-lista-pedido').textContent =
    `Pedido: ${data.numPedido}`;
  const d = data.datosInstalacion;
  document.getElementById('cierre-lista-meta').textContent =
    `${d.puntoAbanderamiento || '—'} · ${d.fecha || '—'} · ${d.nombreIngeniero || '—'}`;

  // Progreso
  const cerradas = cierres.filter(c => c.cerrada).length;
  const total    = incs.length;
  document.getElementById('cierre-counter-badge').textContent = `${cerradas}/${total}`;
  document.getElementById('cierre-progress-text').textContent = `${cerradas} / ${total} cerradas`;
  document.getElementById('cierre-progress-fill').style.width =
    total > 0 ? `${Math.round(cerradas / total * 100)}%` : '0%';

  // Lista
  const list = document.getElementById('cierre-inc-list');
  list.innerHTML = incs.map((inc, i) => {
    const c     = cierres[i];
    const done  = c.cerrada;
    const tipo  = inc.tipo === 'material' ? 'CON MATERIAL' :
                  inc.tipo === 'documentacion' ? 'DOCUMENTACIÓN' : 'SIN MATERIAL';
    const tagCls= inc.tipo === 'material' ? 'tag-material' :
                  inc.tipo === 'documentacion' ? 'tag-doc' : 'tag-equipo';
    return `
      <div class="cierre-inc-card ${done ? 'done' : 'pending'}" onclick="abrirCierreIncidencia(${i})">
        <div class="cierre-status-dot ${done ? 'done' : 'pending'}"></div>
        <div class="cierre-inc-info">
          <div class="cierre-inc-codigo">${inc.codigo}</div>
          <div class="cierre-inc-desc">${inc.descripcion}</div>
          <div style="margin-top:4px">
            <span class="tag ${tagCls}">${tipo}</span>
            ${done ? '<span style="font-size:11px;color:var(--accent-green);margin-left:8px;font-family:var(--font-cond);font-weight:700">✓ CERRADA</span>' : ''}
          </div>
        </div>
        <div style="color:var(--accent);font-size:22px;font-weight:300">›</div>
      </div>`;
  }).join('');

  // Botón generar informe
  const btn = document.getElementById('btn-generar-cierre');
  btn.style.display = (cerradas === total && total > 0) ? 'flex' : 'none';
}

// ╔══════════════════════════════════════════════════════════════╗
// ║            CIERRE INDIVIDUAL DE INCIDENCIA                  ║
// ╚══════════════════════════════════════════════════════════════╝

function abrirCierreIncidencia(i) {
  cierreState.indiceActual = i;
  const inc    = cierreState.incidencias[i];
  const cierre = cierreState.cierres[i];

  // Restaurar fotos temporales
  cierreState.fotosCierre = [...(cierre.fotos || [])];

  // Título
  document.getElementById('cierre-inc-title').textContent =
    `CIERRE #${String(inc.num).padStart(3,'0')}`;
  document.getElementById('cierre-inc-codigo').textContent = inc.codigo;

  // Incidencia original
  document.getElementById('cierre-orig-desc').textContent = inc.descripcion || '—';
  const extraEl = document.getElementById('cierre-orig-extra');
  const extra = inc.infoMaterial || inc.descDocumentacion || inc.descEquipo || '';
  if (extra) {
    const label = inc.infoMaterial ? 'Material necesario' :
                  inc.descDocumentacion ? 'Modificación documentación' : 'Trabajo a realizar';
    extraEl.innerHTML = `<strong style="color:var(--text3);font-family:var(--font-cond);font-size:11px;letter-spacing:1px">${label.toUpperCase()}: </strong>${extra}`;
    extraEl.style.display = 'block';
  } else {
    extraEl.style.display = 'none';
  }

  const tipoBadge = document.getElementById('cierre-orig-tipo-badge');
  const tipo = inc.tipo === 'material' ? 'CON MATERIAL' :
               inc.tipo === 'documentacion' ? 'DOCUMENTACIÓN' : 'SIN MATERIAL';
  const tagCls = inc.tipo === 'material' ? 'tag-material' :
                 inc.tipo === 'documentacion' ? 'tag-doc' : 'tag-equipo';
  tipoBadge.innerHTML = `<span class="tag ${tagCls}">${tipo}</span>`;

  // Comentario existente
  document.getElementById('cierre-comentario').value = cierre.comentario || '';

  // Renderizar fotos
  renderCierreFotos();

  goTo('screen-cierre-inc');
}

function cierreAddFoto(src) {
  if (src === 'camera') {
    document.getElementById('cierre-camera-input').value = '';
    document.getElementById('cierre-camera-input').click();
  } else {
    document.getElementById('cierre-foto-input').value = '';
    document.getElementById('cierre-foto-input').click();
  }
}

function handleCierreFotoInput(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      cierreState.fotosCierre.push(e.target.result);
      renderCierreFotos();
    };
    reader.readAsDataURL(file);
  });
}

function renderCierreFotos() {
  const fotos = cierreState.fotosCierre;
  const grid  = document.getElementById('cierre-fotos-grid');
  const count = document.getElementById('cierre-foto-count');
  count.textContent = `${fotos.length} foto${fotos.length !== 1 ? 's' : ''}`;

  grid.innerHTML = fotos.map((f, i) => `
    <div class="foto-thumb">
      <img src="${f}" alt="Foto cierre ${i+1}">
      <button class="foto-remove" onclick="eliminarCierreFoto(${i})">×</button>
    </div>
  `).join('');
}

function eliminarCierreFoto(i) {
  cierreState.fotosCierre.splice(i, 1);
  renderCierreFotos();
}

function guardarCierreIncidencia() {
  const i         = cierreState.indiceActual;
  const comentario = document.getElementById('cierre-comentario').value.trim();

  cierreState.cierres[i] = {
    fotos:      [...cierreState.fotosCierre],
    comentario: comentario,
    cerrada:    true,
  };

  showToast('✓ Cierre de incidencia guardado', 'success');
  renderCierreListado();
  goTo('screen-cierre-lista');
}

// ╔══════════════════════════════════════════════════════════════╗
// ║           GENERAR INFORME DE CIERRE PDF                     ║
// ╚══════════════════════════════════════════════════════════════╝

async function generarInformeCierre() {
  showLoading('Generando informe de cierre...');
  try {
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    const { jsPDF } = window.jspdf;
    const doc    = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const W = 210, H = 297, margin = 14, colW = W - 2 * margin;
    let y = 0;

    const data   = cierreState.datosInforme;
    const datos  = data.datosInstalacion;
    const numPedido = data.numPedido;
    const fechaVisita = datos.fecha
      ? new Date(datos.fecha + 'T00:00:00').toLocaleDateString('es-ES', { year:'numeric', month:'long', day:'numeric' })
      : '';
    const fechaHoy = new Date().toLocaleDateString('es-ES', { year:'numeric', month:'long', day:'numeric' });

    // ── PORTADA ──
    doc.setFillColor(10, 22, 40);
    doc.rect(0, 0, W, H, 'F');
    doc.setFillColor(0, 107, 151);
    doc.rect(0, 0, W, 28, 'F');
    try { doc.addImage(LOGO_B64, 'JPEG', margin, 3, 22, 22); } catch(e) {}
    doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(255,255,255);
    doc.text('ROURA CEVASA', margin + 26, 13);
    doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(180,220,240);
    doc.text('GESTIÓN DE INSTALACIONES', margin + 26, 21);

    y = 50;
    doc.setFillColor(0, 107, 151);
    doc.rect(margin, y, 3, 24, 'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(24); doc.setTextColor(255,255,255);
    doc.text('INFORME DE CIERRE CFO', margin + 8, y + 10);
    doc.setFontSize(12); doc.setTextColor(0, 107, 151);
    doc.text('RESOLUCIÓN DE INCIDENCIAS', margin + 8, y + 20);

    y = 90;
    // Tabla datos proyecto
    const rows = [
      ['Nº Pedido', numPedido],
      ['Punto de abanderamiento', datos.puntoAbanderamiento || '—'],
      ['Fecha visita original', fechaVisita],
      ['Fecha de cierre', fechaHoy],
      ['Ingeniero responsable', datos.nombreIngeniero || '—'],
      ['Teléfono', datos.telIngeniero || '—'],
      ['Ubicación', datos.ubicacion || '—'],
    ];
    rows.forEach(([lbl, val]) => {
      doc.setFillColor(22, 32, 53); doc.rect(margin, y, colW, 9, 'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(100,140,180);
      doc.text(lbl.toUpperCase(), margin + 3, y + 6);
      doc.setFont('helvetica','normal'); doc.setTextColor(220,235,255);
      doc.text(String(val), margin + 80, y + 6);
      y += 10;
    });

    y += 14;
    // Resumen numérico
    const total = cierreState.incidencias.length;
    doc.setFillColor(0, 107, 151); doc.rect(margin, y, colW, 16, 'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(255,255,255);
    doc.text(`TOTAL INCIDENCIAS CERRADAS: ${total} / ${total}`, margin + 4, y + 10);
    y += 24;

    // ── PÁGINAS POR INCIDENCIA ──
    for (let idx = 0; idx < cierreState.incidencias.length; idx++) {
      const inc    = cierreState.incidencias[idx];
      const cierre = cierreState.cierres[idx];

      // Nueva página para cada incidencia
      doc.addPage();
      y = 0;

      // Cabecera de página
      doc.setFillColor(10, 22, 40); doc.rect(0, 0, W, H, 'F');
      doc.setFillColor(0, 107, 151); doc.rect(0, 0, W, 14, 'F');
      try { doc.addImage(LOGO_B64, 'JPEG', margin, 2, 10, 10); } catch(e) {}
      doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
      doc.text('ROURA CEVASA · INFORME DE CIERRE CFO', margin + 13, 9);
      doc.text(`Pág. ${idx + 2}`, W - margin, 9, { align:'right' });
      y = 22;

      // Banda código incidencia
      doc.setFillColor(22, 32, 53); doc.rect(margin, y, colW, 18, 'F');
      doc.setFillColor(0, 107, 151); doc.rect(margin, y, 3, 18, 'F');
      doc.setFontSize(7); doc.setFont('helvetica','bold'); doc.setTextColor(140,160,190);
      doc.text('CÓDIGO INCIDENCIA', margin + 7, y + 6);
      doc.setFontSize(12); doc.setTextColor(0,107,151);
      doc.text(inc.codigo, margin + 7, y + 14);

      // Badge tipo
      const tipoTexto = inc.tipo === 'material' ? 'CON MATERIAL' :
                        inc.tipo === 'documentacion' ? 'MODIF. DOCUMENTACIÓN' : 'SIN MATERIAL';
      const tipoColor = inc.tipo === 'material' ? [200,60,60] :
                        inc.tipo === 'documentacion' ? [60,100,200] : [32,180,100];
      doc.setFillColor(...tipoColor);
      doc.setFontSize(7); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
      const tipoW = doc.getTextWidth(tipoTexto) + 10;
      doc.roundedRect(W - margin - tipoW, y + 6, tipoW, 8, 1.5, 1.5, 'F');
      doc.text(tipoTexto, W - margin - tipoW / 2, y + 12, { align:'center' });
      y += 26;

      // ── SECCIÓN 1: INCIDENCIA ORIGINAL ──
      doc.setFillColor(0, 107, 151);
      doc.rect(margin, y, colW, 8, 'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(8); doc.setTextColor(255,255,255);
      doc.text('▌  INCIDENCIA ORIGINAL', margin + 3, y + 5.5);
      y += 10;

      // Descripción
      doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(100,140,180);
      doc.text('DESCRIPCIÓN', margin + 2, y + 4);
      doc.setDrawColor(0,107,151); doc.line(margin, y+5, W-margin, y+5); y += 8;
      doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(220,235,255);
      const descLines = doc.splitTextToSize(inc.descripcion || '—', colW - 4);
      doc.text(descLines, margin + 2, y);
      y += descLines.length * 5 + 6;

      // Info extra de la incidencia
      const extra = inc.infoMaterial || inc.descDocumentacion || inc.descEquipo;
      if (extra) {
        const extraLabel = inc.infoMaterial ? 'MATERIAL NECESARIO' :
                           inc.descDocumentacion ? 'MODIFICACIÓN DOCUMENTACIÓN' : 'TRABAJO A REALIZAR';
        doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(100,140,180);
        doc.text(extraLabel, margin + 2, y + 4);
        doc.setDrawColor(100,140,180); doc.setLineDashPattern([2,2],0);
        doc.line(margin, y+5, W-margin, y+5); doc.setLineDashPattern([],0); y += 8;
        doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(180,200,230);
        const extLines = doc.splitTextToSize(extra, colW - 4);
        doc.text(extLines, margin + 2, y);
        y += extLines.length * 5 + 6;
      }

      // Fotos originales de la incidencia (max 4)
      if (inc.fotos && inc.fotos.length > 0) {
        const fotosOrig = inc.fotos.slice(0, 4);
        doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(100,140,180);
        doc.text(`FOTOGRAFÍAS ORIGINALES (${inc.fotos.length})`, margin + 2, y + 4);
        doc.setDrawColor(100,140,180); doc.setLineDashPattern([2,2],0);
        doc.line(margin, y+5, W-margin, y+5); doc.setLineDashPattern([],0); y += 8;
        y = await addPhotosGrid(doc, fotosOrig, y, margin, colW, W, H);
      }

      y += 6;

      // ── SECCIÓN 2: RESOLUCIÓN ──
      // Check page space
      if (y > H - 80) { doc.addPage(); y = 0;
        doc.setFillColor(10,22,40); doc.rect(0,0,W,H,'F');
        doc.setFillColor(0,107,151); doc.rect(0,0,W,14,'F');
        try { doc.addImage(LOGO_B64,'JPEG',margin,2,10,10); } catch(e) {}
        doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
        doc.text('ROURA CEVASA · INFORME DE CIERRE CFO', margin+13, 9);
        doc.text(`Pág. ${idx+2} (cont.)`, W-margin, 9, {align:'right'}); y = 22;
      }

      doc.setFillColor(32, 192, 96);
      doc.rect(margin, y, colW, 8, 'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(8); doc.setTextColor(10,22,40);
      doc.text('✓  RESOLUCIÓN / CIERRE DE INCIDENCIA', margin + 3, y + 5.5);
      y += 10;

      // Comentario de cierre
      doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(32,192,96);
      doc.text('JUSTIFICACIÓN DEL CIERRE', margin + 2, y + 4);
      doc.setDrawColor(32,192,96); doc.line(margin, y+5, W-margin, y+5); y += 8;
      doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(220,235,255);
      const comentLines = doc.splitTextToSize(cierre.comentario || '(Sin comentario adicional)', colW - 4);
      doc.text(comentLines, margin + 2, y);
      y += comentLines.length * 5 + 6;

      // Fotos de cierre
      if (cierre.fotos && cierre.fotos.length > 0) {
        doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(32,192,96);
        doc.text(`FOTOGRAFÍAS DE RESOLUCIÓN (${cierre.fotos.length})`, margin + 2, y + 4);
        doc.setDrawColor(32,192,96); doc.line(margin, y+5, W-margin, y+5); y += 8;
        y = await addPhotosGrid(doc, cierre.fotos.slice(0, 6), y, margin, colW, W, H);
      }

      // Pie de página
      doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(50,70,100);
      doc.text(`${numPedido} · Cierre ${fechaHoy}`, W/2, H-8, { align:'center' });
    }

    // Descargar
    const filename = `${numPedido} Informe Cierre CFO.pdf`;
    doc.save(filename);
    hideLoading();
    showToast('✓ Informe de cierre descargado', 'success');

    // Mostrar botón Volver al Inicio
    const btnGenerar = document.getElementById('btn-generar-cierre');
    const btnVolver  = document.getElementById('btn-cierre-volver-inicio');
    if (btnGenerar) btnGenerar.style.display = 'none';
    if (btnVolver)  btnVolver.style.display  = 'flex';

    // Subir a Box si hay sesión
    subirPDFCierreABox(doc, numPedido).then(url => {
      if (url) showToast('📦 Informe de cierre subido a Box', 'success');
    }).catch(() => {});

  } catch(err) {
    hideLoading();
    showToast('❌ Error generando informe de cierre: ' + err.message, 'error');
    console.error(err);
  }
}

// ── Volver al inicio desde cierre ──
function volverAlInicioCierre() {
  cierreState = { datosInforme:null, incidencias:[], cierres:[], indiceActual:0, fotosCierre:[] };
  resetCierre();
  const btnGenerar = document.getElementById('btn-generar-cierre');
  const btnVolver  = document.getElementById('btn-cierre-volver-inicio');
  if (btnGenerar) btnGenerar.style.display = 'none';
  if (btnVolver)  btnVolver.style.display  = 'none';
  switchMainTab('cerrar');
  goTo('screen-main');
}

// ── Audio para justificación del cierre ──
function toggleAudioCierre(targetId, btnId) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('Tu navegador no soporta reconocimiento de voz', 'error');
    return;
  }
  const btn = document.getElementById(btnId);
  if (state.recognition) {
    state.recognition.stop();
    state.recognition = null;
    if (btn) { btn.classList.remove('recording'); btn.querySelector('span').textContent = btn.dataset.origText || 'Dictar justificación'; }
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'es-ES';
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.onresult = e => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
    const el = document.getElementById(targetId);
    if (el) el.value = (el.value ? el.value + ' ' : '') + transcript;
  };
  recognition.onerror = () => {
    state.recognition = null;
    if (btn) { btn.classList.remove('recording'); btn.querySelector('span').textContent = btn.dataset.origText || 'Dictar justificación'; }
  };
  recognition.onend = () => {
    state.recognition = null;
    if (btn) { btn.classList.remove('recording'); btn.querySelector('span').textContent = btn.dataset.origText || 'Dictar justificación'; }
  };
  if (btn) {
    btn.dataset.origText = btn.querySelector('span').textContent;
    btn.classList.add('recording');
    btn.querySelector('span').textContent = '● Grabando... (toca para detener)';
  }
  state.recognition = recognition;
  recognition.start();
}


</script>
